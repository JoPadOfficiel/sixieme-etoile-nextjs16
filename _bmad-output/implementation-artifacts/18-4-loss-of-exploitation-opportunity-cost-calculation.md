# Story 18.4: Loss of Exploitation (Opportunity Cost) Calculation

## Story Information

| Field                | Value                                                                |
| -------------------- | -------------------------------------------------------------------- |
| **Story ID**         | 18.4                                                                 |
| **Epic**             | Epic 18 - Advanced Geospatial, Route Optimization & Yield Management |
| **Title**            | Loss of Exploitation (Opportunity Cost) Calculation                  |
| **Status**           | âœ… Done                                                              |
| **Created**          | 2025-12-31                                                           |
| **Completed**        | 2025-12-31                                                           |
| **Priority**         | High                                                                 |
| **Estimated Effort** | 5 Story Points                                                       |
| **Branch**           | feature/18-4-loss-of-exploitation                                    |

---

## User Story

**As an** operator,  
**I want** the system to calculate and include loss of exploitation for multi-day missions,  
**So that** the quote reflects the true cost of immobilizing a vehicle at a remote location.

---

## Related Requirements

| Requirement | Description                                                                                                                                                                                                                                                                                                        |
| ----------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **FR81**    | Le systÃ¨me doit calculer et inclure la perte d'exploitation (coÃ»t d'opportunitÃ©) pour les missions multi-jours oÃ¹ le vÃ©hicule est immobilisÃ© Ã  un emplacement distant, en appliquant un coefficient de saisonnalitÃ© configurable (ex: 80% en haute saison, 50% en basse saison) au revenu journalier de rÃ©fÃ©rence. |

---

## Business Context

### Problem Statement

Lors d'une mission multi-jours (ex: excursion de 3 jours en Normandie), le vÃ©hicule est immobilisÃ© sur place pendant les jours "d'inactivitÃ©" oÃ¹ il attend le client. Pendant ces jours, le vÃ©hicule ne peut pas effectuer d'autres missions, ce qui reprÃ©sente un **manque Ã  gagner** (perte d'exploitation).

**Exemple concret:**

- Mission: Paris â†’ Normandie (3 jours)
- Jour 1: Trajet aller + visite
- Jour 2: VÃ©hicule sur place (client en visite autonome) = **jour d'inactivitÃ©**
- Jour 3: Visite + trajet retour

Le jour 2, le vÃ©hicule aurait pu gÃ©nÃ©rer ~400â‚¬ de CA (prix MAD 8h). Cette perte doit Ãªtre facturÃ©e au client.

### Solution

Le systÃ¨me:

1. DÃ©tecte les **jours d'inactivitÃ©** dans les missions multi-jours
2. Calcule le **revenu journalier de rÃ©fÃ©rence** par catÃ©gorie de vÃ©hicule (basÃ© sur le prix MAD 8h)
3. Applique un **coefficient de saisonnalitÃ©** (haute saison = 80%, basse saison = 50%)
4. Ajoute la **perte d'exploitation** au devis comme composant de coÃ»t sÃ©parÃ©

### Value Proposition

- **RentabilitÃ© rÃ©elle** : Les missions multi-jours incluent le coÃ»t d'opportunitÃ©
- **Transparence** : Le client comprend pourquoi le prix inclut des frais d'immobilisation
- **FlexibilitÃ©** : Coefficients de saisonnalitÃ© configurables par organisation
- **PrÃ©cision** : Revenu de rÃ©fÃ©rence par catÃ©gorie de vÃ©hicule

---

## Acceptance Criteria (BDD)

### AC1: DÃ©tection des jours d'inactivitÃ©

```gherkin
Given une mission multi-jours avec:
  - pickupAt: 2025-07-15 08:00
  - estimatedEndAt: 2025-07-17 18:00
  - DurÃ©e totale: 3 jours
  - Temps de conduite effectif: 12 heures (rÃ©parties sur jour 1 et jour 3)
When le systÃ¨me analyse la mission
Then il doit identifier:
  - Nombre de jours calendaires: 3
  - Jours d'inactivitÃ© (idle days): 1 (jour 2 oÃ¹ le vÃ©hicule attend)
And stocker cette information dans tripAnalysis.lossOfExploitation.idleDays
```

### AC2: Calcul du revenu journalier de rÃ©fÃ©rence

```gherkin
Given une catÃ©gorie de vÃ©hicule "BERLINE" avec:
  - defaultRatePerHour: 50â‚¬/h
  - Ou un MadTimeBucket 8h = 400â‚¬
When le systÃ¨me calcule le revenu journalier de rÃ©fÃ©rence
Then dailyReferenceRevenue = prix MAD 8h pour cette catÃ©gorie
  - Si MadTimeBucket 8h existe: utiliser ce prix (400â‚¬)
  - Sinon: 8h Ã— defaultRatePerHour = 8 Ã— 50 = 400â‚¬
And ce revenu est stockÃ© dans tripAnalysis.lossOfExploitation.dailyReferenceRevenue
```

### AC3: Application du coefficient de saisonnalitÃ©

```gherkin
Given une mission le 15 juillet 2025 (haute saison)
And les coefficients de saisonnalitÃ© configurÃ©s:
  - Haute saison (01/07 - 31/08): 0.80 (80%)
  - Basse saison (01/01 - 28/02): 0.50 (50%)
  - Par dÃ©faut: 0.65 (65%)
When le systÃ¨me calcule la perte d'exploitation
Then il doit appliquer le coefficient 0.80 (haute saison)
And stocker seasonalityCoefficient = 0.80 dans tripAnalysis
```

### AC4: Calcul de la perte d'exploitation

```gherkin
Given une mission avec:
  - idleDays: 2
  - dailyReferenceRevenue: 400â‚¬
  - seasonalityCoefficient: 0.80 (haute saison)
When le systÃ¨me calcule la perte d'exploitation
Then lossOfExploitation = idleDays Ã— dailyRevenue Ã— seasonalityCoefficient
  = 2 Ã— 400 Ã— 0.80 = 640â‚¬
And ce montant est ajoutÃ© au coÃ»t interne du devis
And il est affichÃ© comme composant sÃ©parÃ© dans tripAnalysis.costBreakdown
```

### AC5: IntÃ©gration dans le prix final

```gherkin
Given un devis multi-jours avec:
  - Prix de base (transport): 800â‚¬
  - CoÃ»ts opÃ©rationnels (fuel, tolls, driver): 350â‚¬
  - HÃ©bergement + repas: 180â‚¬
  - Perte d'exploitation: 640â‚¬
When le pricing engine calcule le prix final
Then le coÃ»t interne total = 350 + 180 + 640 = 1170â‚¬
And la marge est calculÃ©e sur ce coÃ»t total
And le prix suggÃ©rÃ© inclut la perte d'exploitation
```

### AC6: Configuration du revenu journalier par catÃ©gorie

```gherkin
Given un admin dans les paramÃ¨tres de pricing
When il accÃ¨de Ã  la section "Loss of Exploitation"
Then il doit pouvoir configurer:
  - dailyReferenceRevenue par VehicleCategory (optionnel, sinon calculÃ©)
  - Ou utiliser le calcul automatique basÃ© sur MAD 8h
And les changements s'appliquent immÃ©diatement aux nouveaux devis
```

### AC7: Configuration des coefficients de saisonnalitÃ©

```gherkin
Given un admin dans les paramÃ¨tres de pricing
When il accÃ¨de Ã  la section "Seasonality Coefficients"
Then il doit pouvoir configurer:
  - defaultSeasonalityCoefficient: coefficient par dÃ©faut (ex: 0.65)
  - highSeasonCoefficient: coefficient haute saison (ex: 0.80)
  - lowSeasonCoefficient: coefficient basse saison (ex: 0.50)
And ces coefficients utilisent les pÃ©riodes des SeasonalMultiplier existants
```

### AC8: Pas de perte d'exploitation pour missions 1 jour

```gherkin
Given une mission sur une seule journÃ©e
  - pickupAt: 2025-07-15 08:00
  - estimatedEndAt: 2025-07-15 18:00
When le systÃ¨me analyse la mission
Then idleDays = 0
And lossOfExploitation = 0â‚¬
And aucun composant "loss of exploitation" n'est ajoutÃ©
```

### AC9: Affichage dans TripTransparency

```gherkin
Given un devis multi-jours avec perte d'exploitation calculÃ©e
When l'opÃ©rateur consulte le TripTransparencyPanel
Then il doit voir une section "Perte d'exploitation" avec:
  - Nombre de jours d'inactivitÃ©
  - Revenu journalier de rÃ©fÃ©rence
  - Coefficient de saisonnalitÃ© appliquÃ©
  - Montant total de la perte
And une explication: "CoÃ»t d'opportunitÃ© pour X jour(s) d'immobilisation vÃ©hicule"
```

### AC10: RÃ¨gle appliquÃ©e dans appliedRules

```gherkin
Given un devis avec perte d'exploitation > 0
When le pricing est finalisÃ©
Then une rÃ¨gle "LOSS_OF_EXPLOITATION" doit Ãªtre ajoutÃ©e Ã  appliedRules
And cette rÃ¨gle doit contenir:
  - type: "LOSS_OF_EXPLOITATION"
  - description: "Perte d'exploitation: X jour(s) Ã— Yâ‚¬ Ã— Z%"
  - amount: montant calculÃ©
  - details: { idleDays, dailyRevenue, seasonalityCoefficient }
```

---

## Technical Design

### 1. Schema Changes (Prisma)

```prisma
// In VehicleCategory model - add daily reference revenue
model VehicleCategory {
  // ... existing fields ...

  // Story 18.4: Daily reference revenue for loss of exploitation calculation
  // If null, calculated as 8h Ã— defaultRatePerHour or from MadTimeBucket 8h
  dailyReferenceRevenue Decimal? @db.Decimal(10, 2) // EUR
}

// In OrganizationPricingSettings model - add seasonality coefficients
model OrganizationPricingSettings {
  // ... existing fields ...

  // Story 18.4: Loss of exploitation seasonality coefficients
  // These coefficients determine what % of daily revenue is "lost" during idle days
  // Higher coefficient = higher opportunity cost (e.g., 0.80 in high season)
  defaultSeasonalityCoefficient Decimal? @db.Decimal(3, 2) @default(0.65) // 65%
  highSeasonCoefficient         Decimal? @db.Decimal(3, 2) @default(0.80) // 80%
  lowSeasonCoefficient          Decimal? @db.Decimal(3, 2) @default(0.50) // 50%
}
```

### 2. New Types (pricing-engine.ts)

```typescript
/**
 * Story 18.4: Loss of exploitation calculation result
 */
export interface LossOfExploitationResult {
  // Mission analysis
  totalDays: number;
  idleDays: number;
  isMultiDay: boolean;

  // Revenue calculation
  dailyReferenceRevenue: number;
  dailyRevenueSource: "CONFIGURED" | "MAD_BUCKET_8H" | "HOURLY_RATE_8H";
  vehicleCategoryId: string | null;
  vehicleCategoryName: string | null;

  // Seasonality
  seasonalityCoefficient: number;
  seasonalityPeriod: "HIGH_SEASON" | "LOW_SEASON" | "DEFAULT";
  seasonalityMultiplierName: string | null;

  // Final calculation
  lossOfExploitation: number; // idleDays Ã— dailyRevenue Ã— coefficient

  // Breakdown for transparency
  calculation: {
    formula: string; // e.g., "2 Ã— 400â‚¬ Ã— 0.80 = 640â‚¬"
    idleDays: number;
    dailyRevenue: number;
    coefficient: number;
    total: number;
  };
}

/**
 * Story 18.4: Applied rule for loss of exploitation
 */
export interface AppliedLossOfExploitationRule extends AppliedRule {
  type: "LOSS_OF_EXPLOITATION";
  description: string;
  amount: number;
  details: {
    idleDays: number;
    dailyRevenue: number;
    seasonalityCoefficient: number;
    seasonalityPeriod: string;
  };
}

/**
 * Extended TripAnalysis with loss of exploitation
 */
export interface TripAnalysis {
  // ... existing fields ...
  lossOfExploitation?: LossOfExploitationResult;
}

/**
 * Extended CostBreakdown with loss of exploitation
 */
export interface CostBreakdown {
  // ... existing fields ...
  lossOfExploitation?: {
    amount: number;
    idleDays: number;
    dailyRevenue: number;
    seasonalityCoefficient: number;
    description: string;
  };
}
```

### 3. Core Functions

#### 3.1 calculateIdleDays()

```typescript
/**
 * Story 18.4: Calculate idle days for a multi-day mission
 *
 * Idle days = total calendar days - days with significant activity
 * A day with significant activity has > 4h of driving/service
 *
 * For simplicity, we use: idleDays = totalDays - 2 (first and last day are active)
 * This is a conservative estimate that can be refined later.
 */
export function calculateIdleDays(
  pickupAt: Date,
  estimatedEndAt: Date,
  totalDrivingMinutes: number
): { totalDays: number; idleDays: number; isMultiDay: boolean } {
  // Calculate total calendar days
  const pickupDate = new Date(pickupAt);
  const endDate = new Date(estimatedEndAt);

  // Set to start of day for accurate day counting
  pickupDate.setHours(0, 0, 0, 0);
  endDate.setHours(0, 0, 0, 0);

  const msPerDay = 24 * 60 * 60 * 1000;
  const totalDays =
    Math.ceil((endDate.getTime() - pickupDate.getTime()) / msPerDay) + 1;

  const isMultiDay = totalDays > 1;

  // For single-day missions, no idle days
  if (!isMultiDay) {
    return { totalDays: 1, idleDays: 0, isMultiDay: false };
  }

  // For multi-day missions:
  // - Day 1: Active (outbound travel + service)
  // - Day N: Active (service + return travel)
  // - Days 2 to N-1: Potentially idle
  //
  // Conservative estimate: all middle days are idle
  const idleDays = Math.max(0, totalDays - 2);

  return { totalDays, idleDays, isMultiDay };
}
```

#### 3.2 getDailyReferenceRevenue()

```typescript
/**
 * Story 18.4: Get daily reference revenue for a vehicle category
 *
 * Priority:
 * 1. VehicleCategory.dailyReferenceRevenue (if configured)
 * 2. MadTimeBucket 8h price for this category
 * 3. 8h Ã— VehicleCategory.defaultRatePerHour
 * 4. 8h Ã— OrganizationPricingSettings.baseRatePerHour
 */
export async function getDailyReferenceRevenue(
  vehicleCategoryId: string | null,
  organizationId: string,
  prisma: PrismaClient
): Promise<{
  revenue: number;
  source: "CONFIGURED" | "MAD_BUCKET_8H" | "HOURLY_RATE_8H";
}> {
  // Get vehicle category if provided
  let vehicleCategory = null;
  if (vehicleCategoryId) {
    vehicleCategory = await prisma.vehicleCategory.findUnique({
      where: { id: vehicleCategoryId },
    });
  }

  // Priority 1: Configured daily reference revenue
  if (vehicleCategory?.dailyReferenceRevenue) {
    return {
      revenue: Number(vehicleCategory.dailyReferenceRevenue),
      source: "CONFIGURED",
    };
  }

  // Priority 2: MAD time bucket 8h
  if (vehicleCategoryId) {
    const settings = await prisma.organizationPricingSettings.findUnique({
      where: { organizationId },
    });

    if (settings) {
      const bucket8h = await prisma.madTimeBucket.findFirst({
        where: {
          pricingSettingsId: settings.id,
          vehicleCategoryId,
          durationHours: 8,
          isActive: true,
        },
      });

      if (bucket8h) {
        return {
          revenue: Number(bucket8h.price),
          source: "MAD_BUCKET_8H",
        };
      }
    }
  }

  // Priority 3: 8h Ã— category hourly rate
  if (vehicleCategory?.defaultRatePerHour) {
    return {
      revenue: 8 * Number(vehicleCategory.defaultRatePerHour),
      source: "HOURLY_RATE_8H",
    };
  }

  // Priority 4: 8h Ã— org base rate
  const settings = await prisma.organizationPricingSettings.findUnique({
    where: { organizationId },
  });

  const baseRatePerHour = settings?.baseRatePerHour
    ? Number(settings.baseRatePerHour)
    : 50;

  return {
    revenue: 8 * baseRatePerHour,
    source: "HOURLY_RATE_8H",
  };
}
```

#### 3.3 getSeasonalityCoefficient()

```typescript
/**
 * Story 18.4: Get seasonality coefficient for a given date
 *
 * Uses existing SeasonalMultiplier to determine if date is in high/low season,
 * then applies the corresponding coefficient from OrganizationPricingSettings.
 */
export async function getSeasonalityCoefficient(
  date: Date,
  organizationId: string,
  prisma: PrismaClient
): Promise<{
  coefficient: number;
  period: "HIGH_SEASON" | "LOW_SEASON" | "DEFAULT";
  multiplierName: string | null;
}> {
  // Get organization settings
  const settings = await prisma.organizationPricingSettings.findUnique({
    where: { organizationId },
  });

  const defaultCoeff = settings?.defaultSeasonalityCoefficient
    ? Number(settings.defaultSeasonalityCoefficient)
    : 0.65;
  const highSeasonCoeff = settings?.highSeasonCoefficient
    ? Number(settings.highSeasonCoefficient)
    : 0.8;
  const lowSeasonCoeff = settings?.lowSeasonCoefficient
    ? Number(settings.lowSeasonCoefficient)
    : 0.5;

  // Find active seasonal multiplier for this date
  const seasonalMultiplier = await prisma.seasonalMultiplier.findFirst({
    where: {
      organizationId,
      isActive: true,
      startDate: { lte: date },
      endDate: { gte: date },
    },
    orderBy: { priority: "desc" },
  });

  if (!seasonalMultiplier) {
    return {
      coefficient: defaultCoeff,
      period: "DEFAULT",
      multiplierName: null,
    };
  }

  // Determine if high or low season based on multiplier value
  const multiplierValue = Number(seasonalMultiplier.multiplier);

  if (multiplierValue >= 1.1) {
    // High season (multiplier >= 1.1 means +10% or more)
    return {
      coefficient: highSeasonCoeff,
      period: "HIGH_SEASON",
      multiplierName: seasonalMultiplier.name,
    };
  } else if (multiplierValue <= 0.95) {
    // Low season (multiplier <= 0.95 means -5% or more discount)
    return {
      coefficient: lowSeasonCoeff,
      period: "LOW_SEASON",
      multiplierName: seasonalMultiplier.name,
    };
  }

  // Default season
  return {
    coefficient: defaultCoeff,
    period: "DEFAULT",
    multiplierName: seasonalMultiplier.name,
  };
}
```

#### 3.4 calculateLossOfExploitation()

```typescript
/**
 * Story 18.4: Calculate loss of exploitation for a multi-day mission
 */
export async function calculateLossOfExploitation(
  pickupAt: Date,
  estimatedEndAt: Date,
  totalDrivingMinutes: number,
  vehicleCategoryId: string | null,
  vehicleCategoryName: string | null,
  organizationId: string,
  prisma: PrismaClient
): Promise<LossOfExploitationResult> {
  // Step 1: Calculate idle days
  const { totalDays, idleDays, isMultiDay } = calculateIdleDays(
    pickupAt,
    estimatedEndAt,
    totalDrivingMinutes
  );

  // Step 2: Get daily reference revenue
  const { revenue: dailyReferenceRevenue, source: dailyRevenueSource } =
    await getDailyReferenceRevenue(vehicleCategoryId, organizationId, prisma);

  // Step 3: Get seasonality coefficient
  const {
    coefficient: seasonalityCoefficient,
    period: seasonalityPeriod,
    multiplierName,
  } = await getSeasonalityCoefficient(pickupAt, organizationId, prisma);

  // Step 4: Calculate loss of exploitation
  const lossOfExploitation =
    Math.round(
      idleDays * dailyReferenceRevenue * seasonalityCoefficient * 100
    ) / 100;

  // Build formula string for transparency
  const formula =
    idleDays > 0
      ? `${idleDays} Ã— ${dailyReferenceRevenue.toFixed(2)}â‚¬ Ã— ${(
          seasonalityCoefficient * 100
        ).toFixed(0)}% = ${lossOfExploitation.toFixed(2)}â‚¬`
      : "N/A (no idle days)";

  return {
    totalDays,
    idleDays,
    isMultiDay,
    dailyReferenceRevenue,
    dailyRevenueSource,
    vehicleCategoryId,
    vehicleCategoryName,
    seasonalityCoefficient,
    seasonalityPeriod,
    seasonalityMultiplierName: multiplierName,
    lossOfExploitation,
    calculation: {
      formula,
      idleDays,
      dailyRevenue: dailyReferenceRevenue,
      coefficient: seasonalityCoefficient,
      total: lossOfExploitation,
    },
  };
}
```

#### 3.5 buildLossOfExploitationRule()

```typescript
/**
 * Story 18.4: Build applied rule for loss of exploitation
 */
export function buildLossOfExploitationRule(
  result: LossOfExploitationResult
): AppliedLossOfExploitationRule | null {
  if (result.idleDays === 0 || result.lossOfExploitation === 0) {
    return null;
  }

  const periodLabel =
    result.seasonalityPeriod === "HIGH_SEASON"
      ? "haute saison"
      : result.seasonalityPeriod === "LOW_SEASON"
      ? "basse saison"
      : "pÃ©riode standard";

  return {
    type: "LOSS_OF_EXPLOITATION",
    description: `Perte d'exploitation: ${
      result.idleDays
    } jour(s) Ã— ${result.dailyReferenceRevenue.toFixed(2)}â‚¬ Ã— ${(
      result.seasonalityCoefficient * 100
    ).toFixed(0)}% (${periodLabel})`,
    amount: result.lossOfExploitation,
    details: {
      idleDays: result.idleDays,
      dailyRevenue: result.dailyReferenceRevenue,
      seasonalityCoefficient: result.seasonalityCoefficient,
      seasonalityPeriod: result.seasonalityPeriod,
    },
  };
}
```

### 4. Integration Points

#### 4.1 pricing-calculate.ts

- AprÃ¨s le calcul du staffing multi-jours (Story 17.3), appeler `calculateLossOfExploitation()`
- Ajouter le rÃ©sultat Ã  `tripAnalysis.lossOfExploitation`
- Ajouter le montant au `costBreakdown.lossOfExploitation`
- Ajouter la rÃ¨gle Ã  `appliedRules` si applicable

#### 4.2 compliance-validator.ts

- Dans `generateMultiDayAlternative()`, inclure la perte d'exploitation dans le calcul du coÃ»t total

#### 4.3 TripTransparencyPanel

- Afficher la section "Perte d'exploitation" si `tripAnalysis.lossOfExploitation.idleDays > 0`
- Montrer le dÃ©tail du calcul avec formule

### 5. Files to Modify/Create

| File                                                               | Action | Description                                                                                               |
| ------------------------------------------------------------------ | ------ | --------------------------------------------------------------------------------------------------------- |
| `packages/database/prisma/schema.prisma`                           | Modify | Add dailyReferenceRevenue to VehicleCategory, add seasonality coefficients to OrganizationPricingSettings |
| `packages/api/src/services/pricing-engine.ts`                      | Modify | Add types and calculation functions                                                                       |
| `packages/api/src/routes/vtc/pricing-calculate.ts`                 | Modify | Integrate loss of exploitation calculation                                                                |
| `packages/api/src/services/__tests__/loss-of-exploitation.test.ts` | Create | Unit tests                                                                                                |
| `apps/web/app/[locale]/(app)/dashboard/settings/pricing/page.tsx`  | Modify | Add seasonality coefficients config UI (optional, can defer)                                              |

---

## Test Cases

### Unit Tests (Vitest)

| Test ID | Description                                          | Expected Result                            |
| ------- | ---------------------------------------------------- | ------------------------------------------ |
| LOE-01  | Calculate idle days for 1-day mission                | idleDays = 0                               |
| LOE-02  | Calculate idle days for 2-day mission                | idleDays = 0                               |
| LOE-03  | Calculate idle days for 3-day mission                | idleDays = 1                               |
| LOE-04  | Calculate idle days for 5-day mission                | idleDays = 3                               |
| LOE-05  | Get daily revenue from configured value              | Uses VehicleCategory.dailyReferenceRevenue |
| LOE-06  | Get daily revenue from MAD bucket 8h                 | Uses MadTimeBucket price                   |
| LOE-07  | Get daily revenue from hourly rate                   | 8 Ã— defaultRatePerHour                     |
| LOE-08  | Get seasonality coefficient - high season            | coefficient = 0.80                         |
| LOE-09  | Get seasonality coefficient - low season             | coefficient = 0.50                         |
| LOE-10  | Get seasonality coefficient - default                | coefficient = 0.65                         |
| LOE-11  | Calculate loss of exploitation (3 days, high season) | 1 Ã— 400 Ã— 0.80 = 320â‚¬                      |
| LOE-12  | Calculate loss of exploitation (5 days, low season)  | 3 Ã— 400 Ã— 0.50 = 600â‚¬                      |
| LOE-13  | Build applied rule with correct description          | Rule contains formula                      |
| LOE-14  | No rule for 0 idle days                              | Returns null                               |

### Integration Tests (API)

| Test ID | Description                                               | Expected Result                            |
| ------- | --------------------------------------------------------- | ------------------------------------------ |
| API-01  | POST /pricing/calculate with 3-day excursion              | Returns lossOfExploitation in tripAnalysis |
| API-02  | POST /pricing/calculate with 1-day transfer               | No lossOfExploitation                      |
| API-03  | POST /pricing/calculate with 5-day mission in high season | Correct coefficient applied                |
| API-04  | Verify loss of exploitation added to internal cost        | costBreakdown includes LOE                 |

### E2E Tests (Playwright)

| Test ID | Description                            | Expected Result                    |
| ------- | -------------------------------------- | ---------------------------------- |
| E2E-01  | Create 3-day excursion quote           | LOE visible in TripTransparency    |
| E2E-02  | Verify LOE calculation in quote detail | Shows formula and breakdown        |
| E2E-03  | Configure seasonality coefficients     | Settings saved (if UI implemented) |

### Database Verification (Curl + PostgreSQL MCP)

| Test ID | Description                               | Verification                      |
| ------- | ----------------------------------------- | --------------------------------- |
| DB-01   | VehicleCategory has dailyReferenceRevenue | Query VehicleCategory             |
| DB-02   | Settings have seasonality coefficients    | Query OrganizationPricingSettings |
| DB-03   | Quote tripAnalysis contains LOE           | Query Quote.tripAnalysis JSON     |

---

## Dependencies

| Dependency                             | Type         | Status     |
| -------------------------------------- | ------------ | ---------- |
| Story 17.3 (Compliance Integration)    | Prerequisite | âœ… Done    |
| Story 17.5 (estimatedEndAt)            | Prerequisite | âœ… Done    |
| Epic 9 (Seasonal Multipliers)          | Related      | âœ… Done    |
| Story 18.5 (Stay vs Return Comparison) | Follow-up    | ðŸ“‹ Backlog |

---

## Tasks / Subtasks

- [ ] **Task 1: Schema Migration** (AC: 6, 7)

  - [ ] Add `dailyReferenceRevenue` to VehicleCategory
  - [ ] Add seasonality coefficient fields to OrganizationPricingSettings
  - [ ] Run prisma migrate dev
  - [ ] Verify migration success

- [ ] **Task 2: Core Calculation Functions** (AC: 1, 2, 3, 4)

  - [ ] Implement `calculateIdleDays()` function
  - [ ] Implement `getDailyReferenceRevenue()` function
  - [ ] Implement `getSeasonalityCoefficient()` function
  - [ ] Implement `calculateLossOfExploitation()` function
  - [ ] Add TypeScript types for LossOfExploitationResult

- [ ] **Task 3: Applied Rule Builder** (AC: 10)

  - [ ] Implement `buildLossOfExploitationRule()` function
  - [ ] Add AppliedLossOfExploitationRule type

- [ ] **Task 4: Pricing Engine Integration** (AC: 5, 9)

  - [ ] Integrate in pricing-calculate.ts for multi-day missions
  - [ ] Add to costBreakdown
  - [ ] Add to tripAnalysis
  - [ ] Add to appliedRules

- [ ] **Task 5: Unit Tests** (AC: 1-10)

  - [ ] Create loss-of-exploitation.test.ts
  - [ ] Test idle days calculation
  - [ ] Test daily revenue retrieval
  - [ ] Test seasonality coefficient
  - [ ] Test full calculation
  - [ ] Test rule building

- [ ] **Task 6: API Integration Tests** (AC: all)

  - [ ] Test pricing endpoint with multi-day scenarios
  - [ ] Verify response structure

- [ ] **Task 7: Documentation** (AC: all)
  - [ ] Update story file with completion notes

---

## Dev Notes

### Relevant Architecture Patterns

- **Pricing Engine Pattern**: Follow existing pattern from Stories 18.2/18.3
- **Settings Pattern**: Add fields to OrganizationPricingSettings and VehicleCategory
- **TripAnalysis Pattern**: Store calculation results in tripAnalysis JSON field
- **AppliedRules Pattern**: Add rule to appliedRules array for transparency

### Source Tree Components to Touch

- `packages/database/prisma/schema.prisma` - VehicleCategory and OrganizationPricingSettings models
- `packages/api/src/services/pricing-engine.ts` - Types and functions
- `packages/api/src/routes/vtc/pricing-calculate.ts` - Integration
- `packages/api/src/services/__tests__/loss-of-exploitation.test.ts` - Tests

### Testing Standards

- Unit tests with Vitest in `__tests__` folder
- API tests with curl commands
- Database verification with PostgreSQL MCP

### Project Structure Notes

- Follow existing naming conventions (kebab-case for files)
- Reuse existing SeasonalMultiplier model for season detection
- Use existing MadTimeBucket for daily revenue calculation

### Key Business Rules

1. **Idle Days Calculation**: `totalDays - 2` (first and last day are active)
2. **Daily Revenue Priority**: Configured > MAD Bucket 8h > Hourly Rate Ã— 8
3. **Seasonality Detection**: Based on existing SeasonalMultiplier periods
4. **High Season**: Multiplier >= 1.10 â†’ coefficient 0.80
5. **Low Season**: Multiplier <= 0.95 â†’ coefficient 0.50
6. **Default**: coefficient 0.65

### References

- [Source: docs/bmad/epics.md#Story-18.4]
- [Source: docs/bmad/prd.md#FR81]
- [Source: _bmad-output/implementation-artifacts/18-3-round-trip-to-mad-automatic-detection.md]
- [Source: _bmad-output/implementation-artifacts/17-3-automatic-compliance-driven-staffing-integration.md]

---

## Definition of Done

- [ ] Schema migration applied successfully
- [ ] `calculateIdleDays()` function implemented and tested
- [ ] `getDailyReferenceRevenue()` function implemented and tested
- [ ] `getSeasonalityCoefficient()` function implemented and tested
- [ ] `calculateLossOfExploitation()` function implemented and tested
- [ ] Integration in pricing-calculate.ts complete
- [ ] Unit tests passing (100% coverage on new code)
- [ ] API integration tests passing
- [ ] Loss of exploitation visible in tripAnalysis
- [ ] Applied rule added to appliedRules
- [ ] Documentation updated
- [ ] Code reviewed and approved

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (Cascade)

### Debug Log References

- Migration: `20251231110652_story_18_4_loss_of_exploitation`

### Completion Notes List

1. **Schema Migration** adds 4 fields:

   - `VehicleCategory.dailyReferenceRevenue` (Decimal, optional) - Configurable daily revenue
   - `OrganizationPricingSettings.defaultSeasonalityCoefficient` (default: 0.65 = 65%)
   - `OrganizationPricingSettings.highSeasonCoefficient` (default: 0.80 = 80%)
   - `OrganizationPricingSettings.lowSeasonCoefficient` (default: 0.50 = 50%)

2. **Core Functions** implemented in `pricing-engine.ts`:

   - `calculateIdleDays()` - Calculates idle days for multi-day missions (totalDays - 2)
   - `getDailyReferenceRevenue()` - Gets daily revenue from category config or hourly rate Ã— 8
   - `getSeasonalityCoefficient()` - Determines coefficient based on SeasonalMultiplier
   - `calculateLossOfExploitation()` - Main calculation function
   - `buildLossOfExploitationRule()` - Builds transparency rule for appliedRules

3. **Types** added:

   - `LossOfExploitationResult` - Full calculation result with breakdown
   - `AppliedLossOfExploitationRule` - Rule for appliedRules array
   - `DailyRevenueSource` - Source tracking (CONFIGURED, MAD_BUCKET_8H, HOURLY_RATE_8H)
   - `SeasonalityPeriod` - Period classification (HIGH_SEASON, LOW_SEASON, DEFAULT)
   - `LossOfExploitationSettings` - Flexible settings interface for Prisma Decimal compatibility

4. **Business Rules**:

   - Idle days = totalDays - 2 (first and last day are active)
   - High season: SeasonalMultiplier >= 1.10 â†’ coefficient 0.80
   - Low season: SeasonalMultiplier <= 0.95 â†’ coefficient 0.50
   - Default: coefficient 0.65
   - Formula: `idleDays Ã— dailyRevenue Ã— seasonalityCoefficient`

5. **Unit Tests**: 27/27 passing

   - calculateIdleDays: 6 tests
   - getDailyReferenceRevenue: 4 tests
   - getSeasonalityCoefficient: 5 tests
   - calculateLossOfExploitation: 5 tests
   - buildLossOfExploitationRule: 4 tests
   - Edge cases: 3 tests

6. **Database Verification**:
   - `organization_pricing_settings` has new seasonality coefficient fields with defaults
   - `vehicle_category` has new `dailyReferenceRevenue` field

### File List

| File                                                                                               | Action   | Description                                                             |
| -------------------------------------------------------------------------------------------------- | -------- | ----------------------------------------------------------------------- |
| `packages/database/prisma/schema.prisma`                                                           | Modified | Added 4 fields (1 to VehicleCategory, 3 to OrganizationPricingSettings) |
| `packages/database/prisma/migrations/20251231110652_story_18_4_loss_of_exploitation/migration.sql` | Created  | Migration file                                                          |
| `packages/api/src/services/pricing-engine.ts`                                                      | Modified | Added types and 5 calculation functions                                 |
| `packages/api/src/services/__tests__/loss-of-exploitation.test.ts`                                 | Created  | 27 unit tests                                                           |
