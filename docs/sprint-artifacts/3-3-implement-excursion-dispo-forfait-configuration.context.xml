<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story-id>3.3</story-id>
    <story-name>Implement Excursion & Dispo Forfait Configuration</story-name>
    <epic>Epic 3 – Zone Engine & Partner Fixed Grids (Method 1)</epic>
    <created>2025-11-26</created>
    <status>ready-for-dev</status>
  </metadata>

  <problem-statement>
    <description>
      Les zones géographiques (Story 3.1) et les routes zone-à-zone (Story 3.2) sont maintenant 
      implémentées, mais il manque les forfaits pour les excursions et les mises à disposition.
      
      Les partenaires B2B ont besoin de packages standardisés pour :
      - **Excursions** : Normandie (plages du débarquement), Loire Valley (châteaux), Champagne, 
        Versailles, Giverny, Mont-Saint-Michel, etc.
      - **Mises à disposition (Dispo)** : Location horaire avec chauffeur pour événements, 
        mariages, journées VIP, etc.
      
      Sans ces forfaits :
      - Les opérateurs doivent calculer manuellement les prix des excursions récurrentes
      - Les contrats partenaires ne peuvent pas inclure de packages standardisés
      - Le pricing engine (Method 1) est incomplet pour les scénarios hors transfert simple
    </description>
    <business-impact>
      - Perte de temps opérateur sur des calculs répétitifs
      - Risque d'erreurs de pricing sur les excursions longue distance
      - Impossibilité d'honorer les engagements contractuels sur les forfaits
      - Revenus imprévisibles sur les mises à disposition (pas de tarifs de dépassement)
    </business-impact>
  </problem-statement>

  <objectives>
    <primary>
      Créer une interface d'administration permettant de configurer des forfaits d'excursion 
      et de mise à disposition par catégorie de véhicule, avec prix fixes et tarifs de dépassement.
    </primary>
    <secondary>
      - Exposer une API CRUD complète pour ExcursionPackage et DispoPackage
      - Permettre le filtrage par zone, catégorie de véhicule et statut
      - Préparer l'intégration avec les contrats partenaires (junction tables existantes)
      - Préparer l'intégration avec le pricing engine (Story 3.4)
    </secondary>
  </objectives>

  <scope>
    <in-scope>
      - API REST CRUD : GET/POST/PATCH/DELETE /api/vtc/pricing/excursions
      - API REST CRUD : GET/POST/PATCH/DELETE /api/vtc/pricing/dispos
      - UI d'administration : onglets Excursions et Dispos dans Settings → Pricing
      - UI d'édition : formulaires avec zones, catégorie, durée/distance incluses, prix
      - Validation : champs requis, valeurs positives
      - Filtres : par zone, catégorie, statut actif
      - Tests unitaires et E2E
    </in-scope>
    <out-of-scope>
      - Intégration avec le pricing engine (Story 3.4)
      - Assignation des forfaits aux contrats partenaires (UI existante via Story 2.2)
      - Calcul automatique des dépassements (Story 3.4/3.5)
      - Multi-stop itineraries et tours complexes (Post-MVP)
    </out-of-scope>
  </scope>

  <constraints>
    <technical>
      - Les modèles ExcursionPackage et DispoPackage existent déjà dans le schéma Prisma
      - Multi-tenancy : tous les forfaits scoped par organizationId
      - Relations existantes : originZone, destinationZone (PricingZone), vehicleCategory
      - Junction tables existantes : PartnerContractExcursionPackage, PartnerContractDispoPackage
    </technical>
    <business>
      - FR7 : Dual pricing modes (forfaits sont la base de Method 1)
      - FR10 : Excursion and dispo forfaits with fixed prices
      - FR11 : Engagement Rule - prix contractuels garantis
      - FR37 : Admin configuration pour zones, routes, grids, forfaits
    </business>
  </constraints>

  <risks>
    <risk priority="medium">
      <description>Confusion entre excursion et dispo pour les utilisateurs</description>
      <mitigation>UI claire avec descriptions et exemples pour chaque type de forfait.</mitigation>
    </risk>
    <risk priority="low">
      <description>Tarifs de dépassement mal configurés</description>
      <mitigation>Validation côté API avec valeurs par défaut raisonnables et warnings UI.</mitigation>
    </risk>
  </risks>

  <acceptance-criteria>
    <criterion id="AC1">
      Given /app/[orgSlug]/settings/pricing (ou onglet Excursions),
      When I open the page,
      Then I see a table of existing excursion packages with columns: Name, Origin Zone, 
      Destination Zone, Vehicle Category, Included Duration, Included Distance, Price (EUR), 
      Status, Actions.
    </criterion>
    <criterion id="AC2">
      Given I click "Add Excursion",
      When the form opens,
      Then I can set: Name, Description, Origin Zone (optional), Destination Zone (optional), 
      Vehicle Category, Included Duration (hours), Included Distance (km), Price (EUR), 
      and toggle Active status.
    </criterion>
    <criterion id="AC3">
      Given I fill the excursion form and submit,
      When the excursion is created,
      Then an ExcursionPackage record is persisted with organizationId, and the package 
      appears in the table.
    </criterion>
    <criterion id="AC4">
      Given /app/[orgSlug]/settings/pricing (ou onglet Dispos),
      When I open the page,
      Then I see a table of existing dispo packages with columns: Name, Vehicle Category, 
      Included Duration, Included Distance, Base Price (EUR), Overage Rate/km, Overage Rate/hour, 
      Status, Actions.
    </criterion>
    <criterion id="AC5">
      Given I click "Add Dispo",
      When the form opens,
      Then I can set: Name, Description, Vehicle Category, Included Duration (hours), 
      Included Distance (km), Base Price (EUR), Overage Rate per km, Overage Rate per hour, 
      and toggle Active status.
    </criterion>
    <criterion id="AC6">
      Given I fill the dispo form and submit,
      When the dispo is created,
      Then a DispoPackage record is persisted with organizationId, and the package 
      appears in the table.
    </criterion>
    <criterion id="AC7">
      Given an existing excursion or dispo package,
      When I edit and save changes,
      Then the package is updated in the database and the table reflects the changes.
    </criterion>
    <criterion id="AC8">
      Given an existing excursion or dispo package,
      When I delete the package,
      Then the package is removed from the database (unless assigned to partner contracts).
    </criterion>
  </acceptance-criteria>

  <dependencies>
    <dependency type="required" status="done">
      Story 3.1 – Implement PricingZone Model & Zones Editor UI
    </dependency>
    <dependency type="required" status="done">
      Story 3.2 – Implement ZoneRoute Model & Grid Routes Editor
    </dependency>
    <dependency type="required" status="done">
      Story 2.2 – Store Partner Contract Data & Rate Grid Links
    </dependency>
    <dependency type="required" status="done">
      Story 1.1 – Define VTC ERP Prisma Models (VehicleCategory, ExcursionPackage, DispoPackage)
    </dependency>
    <dependency type="required" status="done">
      Story 1.2 – Enforce Organization-Level Multi-Tenancy
    </dependency>
    <dependency type="optional" status="pending">
      Story 3.4 – Apply Engagement Rule for Partner Grid Trips (will use these forfaits)
    </dependency>
  </dependencies>

  <technical-notes>
    <note>
      ExcursionPackage model fields (already in schema):
      - id, organizationId
      - name, description
      - originZoneId, destinationZoneId (optional PricingZone relations)
      - vehicleCategoryId (VehicleCategory relation)
      - includedDurationHours: Decimal (5,2)
      - includedDistanceKm: Decimal (8,2)
      - price: Decimal (10,2) EUR
      - isActive: Boolean
      - createdAt, updatedAt
    </note>
    <note>
      DispoPackage model fields (already in schema):
      - id, organizationId
      - name, description
      - vehicleCategoryId (VehicleCategory relation)
      - includedDurationHours: Decimal (5,2)
      - includedDistanceKm: Decimal (8,2)
      - basePrice: Decimal (10,2) EUR
      - overageRatePerKm: Decimal (10,4) EUR per km
      - overageRatePerHour: Decimal (10,2) EUR per hour
      - isActive: Boolean
      - createdAt, updatedAt
    </note>
    <note>
      API routes: 
      - /api/vtc/pricing/excursions (CRUD)
      - /api/vtc/pricing/dispos (CRUD)
      UI route: /app/[orgSlug]/settings/pricing with tabs for Excursions and Dispos
    </note>
  </technical-notes>

  <artifacts>
    <prd-reference>docs/bmad/prd.md – FR7, FR10, FR11, FR37</prd-reference>
    <epic-reference>docs/bmad/epics.md – Epic 3, Story 3.3</epic-reference>
    <schema-reference>packages/database/prisma/schema.prisma – ExcursionPackage (lines 755-790), DispoPackage (lines 793-824)</schema-reference>
  </artifacts>
</story-context>
