<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story-id>15.3</story-id>
    <title>Apply Vehicle Category Price Multipliers in Dynamic Pricing</title>
    <epic>Epic 15: Pricing Engine Accuracy & Real Cost Integration</epic>
    <created>2025-12-02</created>
    <author>BMad Orchestrator</author>
  </metadata>

  <problem>
    <current-state>
      Le pricing engine calcule le prix dynamique sans tenir compte du multiplicateur
      de catégorie de véhicule (VehicleCategory.priceMultiplier). Tous les véhicules
      sont tarifés au même niveau, qu'il s'agisse d'une Berline standard ou d'un
      Autocar premium.
    </current-state>
    
    <impact>
      <item type="financial">
        Un trajet Autocar (priceMultiplier: 2.5) est facturé au même prix qu'une
        Berline (priceMultiplier: 1.0), causant une perte de 60% du revenu attendu.
      </item>
      <item type="business">
        Pas de différenciation tarifaire entre les catégories de véhicules,
        rendant les véhicules premium non rentables.
      </item>
      <item type="transparency">
        Aucune visibilité sur l'application du multiplicateur de catégorie
        dans les règles appliquées (appliedRules).
      </item>
    </impact>

    <example>
      <scenario>Trajet Paris-CDG avec Autocar vs Berline</scenario>
      <current>
        - Berline (1.0×): Base 100€ → Final 100€
        - Autocar (2.5×): Base 100€ → Final 100€ (WRONG!)
      </current>
      <expected>
        - Berline (1.0×): Base 100€ → Final 100€
        - Autocar (2.5×): Base 100€ → Final 250€ (CORRECT)
      </expected>
    </example>
  </problem>

  <objectives>
    <primary>
      Appliquer VehicleCategory.priceMultiplier au prix dynamique pour que
      les véhicules premium soient tarifés correctement.
    </primary>
    <secondary>
      <item>Ajouter une règle VEHICLE_CATEGORY_MULTIPLIER aux appliedRules</item>
      <item>Ne pas appliquer le multiplicateur en mode FIXED_GRID</item>
      <item>Ignorer le multiplicateur si égal à 1.0 (neutre)</item>
    </secondary>
  </objectives>

  <scope>
    <in-scope>
      <item>Appliquer priceMultiplier dans calculateDynamicBasePrice()</item>
      <item>Créer AppliedVehicleCategoryMultiplierRule type</item>
      <item>Ajouter la règle aux appliedRules quand multiplier != 1.0</item>
      <item>Charger priceMultiplier dans pricing-calculate.ts</item>
      <item>Tests unitaires pour le multiplicateur</item>
    </in-scope>
    <out-of-scope>
      <item>Modification des taux par défaut (Story 15.4)</item>
      <item>UI pour afficher le multiplicateur</item>
      <item>Modification des contrats partenaires</item>
    </out-of-scope>
  </scope>

  <constraints>
    <technical>
      <item>Le multiplicateur doit être appliqué APRÈS le prix de base</item>
      <item>Le multiplicateur doit être appliqué AVANT les autres multiplicateurs (zone, advanced, seasonal)</item>
      <item>Ne pas modifier le comportement FIXED_GRID</item>
    </technical>
    <business>
      <item>Multiplicateur 1.0 = pas de règle ajoutée (neutre)</item>
      <item>Contrats partenaires = prix fixe, pas de multiplicateur</item>
    </business>
  </constraints>

  <risks>
    <risk level="medium">
      <description>Double application du multiplicateur si déjà appliqué ailleurs</description>
      <mitigation>Vérifier que priceMultiplier n'est pas déjà utilisé dans le code</mitigation>
    </risk>
    <risk level="low">
      <description>Régression sur les prix existants</description>
      <mitigation>Tests de non-régression sur les calculs FIXED_GRID</mitigation>
    </risk>
  </risks>

  <technical-context>
    <existing-code>
      <file path="packages/api/src/services/pricing-engine.ts">
        <relevant-functions>
          <function name="calculateDynamicBasePrice">Calcule le prix de base dynamique</function>
          <function name="buildDynamicResult">Construit le résultat avec appliedRules</function>
          <function name="calculatePrice">Point d'entrée principal</function>
        </relevant-functions>
        <relevant-types>
          <type name="AppliedRule">Union type pour toutes les règles appliquées</type>
          <type name="DynamicBaseCalculationRule">Règle pour le calcul de base</type>
        </relevant-types>
      </file>
      <file path="packages/api/src/routes/vtc/pricing-calculate.ts">
        <relevant-section>Chargement de vehicleCategory avec priceMultiplier</relevant-section>
      </file>
      <file path="packages/database/prisma/schema.prisma">
        <model name="VehicleCategory">
          <field name="priceMultiplier" type="Decimal" default="1.0">Multiplicateur de prix</field>
        </model>
      </file>
    </existing-code>

    <data-model>
      <entity name="VehicleCategory">
        <field name="priceMultiplier" type="Decimal(5,2)" default="1.0"/>
        <values>
          <value code="BERLINE" multiplier="1.0"/>
          <value code="VAN_PREMIUM" multiplier="1.3"/>
          <value code="MINIBUS" multiplier="1.8"/>
          <value code="AUTOCAR" multiplier="2.5"/>
          <value code="LUXE" multiplier="2.0"/>
        </values>
      </entity>
    </data-model>
  </technical-context>

  <acceptance-criteria>
    <criterion id="AC1" priority="high">
      <title>Category Multiplier Applied to Dynamic Pricing</title>
      <given>A dynamic pricing calculation for category "Luxe" with priceMultiplier: 2.0</given>
      <when>The base price is calculated as 100€</when>
      <then>The price after category multiplier is 200€</then>
      <and>An appliedRule of type VEHICLE_CATEGORY_MULTIPLIER is added</and>
    </criterion>

    <criterion id="AC2" priority="high">
      <title>Neutral Multiplier (1.0) Not Added</title>
      <given>A dynamic pricing calculation for category "Berline" with priceMultiplier: 1.0</given>
      <when>The base price is calculated</when>
      <then>No VEHICLE_CATEGORY_MULTIPLIER rule is added to appliedRules</then>
    </criterion>

    <criterion id="AC3" priority="high">
      <title>FIXED_GRID Not Affected</title>
      <given>A FIXED_GRID pricing (Method 1) with a matching partner contract</given>
      <when>The route matches the contract</when>
      <then>The vehicle category multiplier is NOT applied</then>
      <and>The contract price is used as-is</and>
    </criterion>

    <criterion id="AC4" priority="medium">
      <title>Multiplier Order Correct</title>
      <given>A dynamic pricing with zone multiplier 1.2 and category multiplier 2.0</given>
      <when>The price is calculated</when>
      <then>Category multiplier is applied BEFORE zone multiplier</then>
      <and>Final = Base × CategoryMultiplier × ZoneMultiplier</and>
    </criterion>

    <criterion id="AC5" priority="medium">
      <title>Transparency in Applied Rules</title>
      <given>A successful dynamic pricing calculation with category multiplier 1.5</given>
      <when>The result is returned</when>
      <then>appliedRules contains a VEHICLE_CATEGORY_MULTIPLIER rule</then>
      <and>The rule shows categoryCode, categoryName, and multiplier value</and>
    </criterion>
  </acceptance-criteria>

  <test-scenarios>
    <scenario id="TS1" type="unit">
      <name>Apply Autocar multiplier (2.5×)</name>
      <input>basePrice: 100, categoryMultiplier: 2.5</input>
      <expected>priceAfterCategory: 250, rule added</expected>
    </scenario>
    <scenario id="TS2" type="unit">
      <name>Skip Berline multiplier (1.0×)</name>
      <input>basePrice: 100, categoryMultiplier: 1.0</input>
      <expected>priceAfterCategory: 100, no rule added</expected>
    </scenario>
    <scenario id="TS3" type="integration">
      <name>FIXED_GRID ignores category multiplier</name>
      <input>pricingMode: FIXED_GRID, contractPrice: 150, categoryMultiplier: 2.0</input>
      <expected>finalPrice: 150, no category rule</expected>
    </scenario>
    <scenario id="TS4" type="integration">
      <name>Multiplier order with zone</name>
      <input>basePrice: 100, categoryMultiplier: 2.0, zoneMultiplier: 1.2</input>
      <expected>finalPrice: 240 (100 × 2.0 × 1.2)</expected>
    </scenario>
  </test-scenarios>
</story-context>
