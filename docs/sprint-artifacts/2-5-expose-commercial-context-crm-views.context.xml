<?xml version="1.0" encoding="UTF-8"?>
<story-context id="2-5-expose-commercial-context-crm-views" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.5</storyId>
    <title>Expose Commercial Context in CRM Views</title>
    <status>drafted</status>
    <generatedAt>2025-11-28T09:30:00+01:00</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-5-expose-commercial-context-crm-views.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>commercial manager</asA>
    <iWant>CRM views that show key commercial metrics per client</iWant>
    <soThat>I can see which partners are most active and drive revenue</soThat>
    <tasks>
      <task id="1">Extend ContactsTable to show average margin band indicator</task>
      <task id="2">Create ContactCommercialSummary component for detail view</task>
      <task id="3">Add API endpoint for contact commercial metrics aggregation</task>
      <task id="4">Integrate ProfitabilityIndicator in contacts list</task>
      <task id="5">Add commission summary and typical grids panel in contact detail</task>
      <task id="6">Add translations for commercial metrics labels</task>
      <task id="7">Write tests for commercial metrics API and components</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">
      <given>the Contacts list</given>
      <when>I view a row</when>
      <then>I see counters such as Quotes count, Invoices count and possibly average margin band (e.g. profitability light reused from quotes) for that contact</then>
    </criterion>
    <criterion id="AC2">
      <given>a Contact detail view</given>
      <when>I open it</when>
      <then>I see a timeline of recent quotes and missions plus a panel summarising commissions, typical grids used and overall profitability trend</then>
    </criterion>
    <criterion id="AC3">
      <notes>Use lightweight aggregation queries to display counts and basic metrics; full analytics/reporting belongs in Epic 9</notes>
    </criterion>
    <criterion id="AC4">
      <notes>Metrics are advisory and do not need to be 100% real-time; caching is acceptable</notes>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/bmad/prd.md</path>
        <title>Product Requirements Document</title>
        <section>FR Group 1 – Client Segmentation &amp; CRM (FR1–FR6)</section>
        <snippet>FR1-FR6 define client types (partner/private), partner contract data, client reclassification, links between clients, quotes and invoices.</snippet>
      </doc>
      <doc>
        <path>docs/bmad/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 2.5: Expose Commercial Context in CRM Views</section>
        <snippet>CRM views showing key commercial metrics per client: Quotes count, Invoices count, average margin band, commissions, typical grids used, profitability trend.</snippet>
      </doc>
      <doc>
        <path>docs/bmad/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>8.2 Contacts / CRM</section>
        <snippet>Contact Detail: Left (identity), Center (timeline of quotes &amp; missions), Right (commercial settings - commissions for partners, default VAT regime).</snippet>
      </doc>
      <doc>
        <path>docs/bmad/tech-spec.md</path>
        <title>Technical Specification</title>
        <section>Core Tenancy &amp; CRM - Contact model</section>
        <snippet>Contact model with isPartner flag, relations to quotes[], invoices[], partnerContract for commercial settings.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>apps/web/modules/saas/contacts/components/ContactsTable.tsx</path>
        <kind>component</kind>
        <symbol>ContactsTable</symbol>
        <lines>1-214</lines>
        <reason>Main contacts list component - needs extension for average margin indicator</reason>
      </file>
      <file>
        <path>apps/web/modules/saas/contacts/components/ContactDrawer.tsx</path>
        <kind>component</kind>
        <symbol>ContactDrawer</symbol>
        <lines>1-112</lines>
        <reason>Contact detail drawer with tabs - needs commercial summary tab/panel</reason>
      </file>
      <file>
        <path>apps/web/modules/saas/contacts/components/ContactTimeline.tsx</path>
        <kind>component</kind>
        <symbol>ContactTimeline, TimelineSummaryCard</symbol>
        <lines>1-344</lines>
        <reason>Existing timeline with basic summary - can be extended for commercial metrics</reason>
      </file>
      <file>
        <path>apps/web/modules/saas/contacts/types.ts</path>
        <kind>types</kind>
        <symbol>ContactWithCounts, TimelineSummary</symbol>
        <lines>1-135</lines>
        <reason>Type definitions - needs extension for commercial metrics types</reason>
      </file>
      <file>
        <path>apps/web/modules/saas/shared/components/ProfitabilityIndicator.tsx</path>
        <kind>component</kind>
        <symbol>ProfitabilityIndicator</symbol>
        <lines>1-149</lines>
        <reason>Reusable profitability indicator - to be used in contacts list for average margin</reason>
      </file>
      <file>
        <path>packages/api/src/routes/vtc/contacts.ts</path>
        <kind>api-route</kind>
        <symbol>contactsRouter</symbol>
        <lines>1-422</lines>
        <reason>Contacts API - needs new endpoint for commercial metrics aggregation</reason>
      </file>
      <file>
        <path>packages/database/prisma/schema.prisma</path>
        <kind>schema</kind>
        <symbol>Contact, PartnerContract, Quote</symbol>
        <lines>340-450</lines>
        <reason>Database schema for Contact with relations to quotes, invoices, partnerContract</reason>
      </file>
    </code>

    <dependencies>
      <node>
        <package>@tanstack/react-query</package>
        <version>^5.x</version>
        <reason>Data fetching and caching for commercial metrics</reason>
      </node>
      <node>
        <package>lucide-react</package>
        <version>^0.x</version>
        <reason>Icons for commercial metrics display</reason>
      </node>
      <node>
        <package>next-intl</package>
        <version>^3.x</version>
        <reason>Translations for commercial metrics labels</reason>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Use lightweight aggregation queries - full analytics belongs in Epic 9</constraint>
    <constraint>Metrics are advisory, caching is acceptable (not real-time)</constraint>
    <constraint>Reuse existing ProfitabilityIndicator component for consistency</constraint>
    <constraint>Follow existing patterns from ContactTimeline for data fetching</constraint>
    <constraint>Multi-tenancy: all queries must be scoped by organizationId</constraint>
    <constraint>EUR-only monetary representation</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GET /api/vtc/contacts/:id/commercial-metrics</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/vtc/contacts/:id/commercial-metrics -> { averageMarginPercent, totalRevenue, totalQuotesValue, profitabilityBand, commissionSummary, typicalGrids }</signature>
      <path>packages/api/src/routes/vtc/contacts.ts</path>
    </interface>
    <interface>
      <name>ContactWithCommercialMetrics</name>
      <kind>TypeScript interface</kind>
      <signature>interface ContactWithCommercialMetrics extends ContactWithCounts { commercialMetrics: CommercialMetrics }</signature>
      <path>apps/web/modules/saas/contacts/types.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Use Vitest for unit tests, Playwright MCP for E2E tests.
      Follow existing test patterns in packages/api/src/routes/vtc/__tests__/.
      Test API endpoints with curl and verify DB state via postgres MCP.
    </standards>
    <locations>
      <location>packages/api/src/routes/vtc/__tests__/contacts.test.ts</location>
      <location>apps/web/modules/saas/contacts/components/__tests__/</location>
    </locations>
    <ideas>
      <idea acRef="AC1">Test that contacts list displays average margin indicator for contacts with quotes</idea>
      <idea acRef="AC1">Test that contacts without quotes show neutral/unknown margin state</idea>
      <idea acRef="AC2">Test commercial summary panel displays commission percentage for partners</idea>
      <idea acRef="AC2">Test typical grids section shows assigned zone routes for partners</idea>
      <idea acRef="AC3">Test aggregation query performance with large number of quotes</idea>
      <idea acRef="AC4">Verify caching behavior for commercial metrics</idea>
    </ideas>
  </tests>
</story-context>
