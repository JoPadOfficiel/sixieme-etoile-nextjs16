<story-context id="story-1.3-eur-only" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.3</storyId>
    <title>Implement EUR-Only Monetary Representation</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-25T21:00:00+01:00</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-3-implement-eur-only-monetary-representation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>finance user</asA>
    <iWant>all monetary amounts to be stored and displayed in EUR consistently</iWant>
    <soThat>pricing and invoicing behave predictably without FX complexity</soThat>
    <tasks>
      <task id="1">Audit and validate Prisma monetary fields for Decimal consistency</task>
      <task id="2">Create EUR formatting utilities (formatEUR, parseEUR, CURRENCY_CODE)</task>
      <task id="3">Update API response types with EUR documentation</task>
      <task id="4">Create frontend EUR formatting components (EURDisplay, EURInput)</task>
      <task id="5">Validate no FX code paths exist in codebase</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">EUR-only monetary fields - all monetary fields store currency as "EUR" with no currency conversion code paths</criterion>
    <criterion id="AC2">Consistent EUR display in UI - all amounts formatted with € symbol and French locale (1 234,56 €)</criterion>
    <criterion id="AC3">API contracts document EUR - OpenAPI documentation explicitly states amounts are in EUR</criterion>
    <criterion id="AC4">Prisma schema validation - all monetary fields use Decimal with consistent precision, currency defaults to "EUR"</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/bmad/tech-spec.md</path>
        <title>VTC ERP Technical Specification</title>
        <section>Implementation Details - EUR Strategy</section>
        <snippet>The system treats EUR as base currency. No multi-currency or FX conversion logic. All amounts in EUR only.</snippet>
      </doc>
      <doc>
        <path>docs/bmad/prd.md</path>
        <title>Product Requirements Document</title>
        <section>FR39 - Currency</section>
        <snippet>The system shall treat EUR as the base currency for pricing and ensure a consistent approach to currency representation in all financial records.</snippet>
      </doc>
      <doc>
        <path>docs/bmad/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 1.3</section>
        <snippet>Implements FR39 from the PRD. EUR as base currency, no multi-currency. API contracts document EUR.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/1-2-enforce-organization-level-multi-tenancy.md</path>
        <title>Story 1.2 Completion</title>
        <section>Completion Notes</section>
        <snippet>VTC API routes use Zod schemas with describeRoute for OpenAPI docs. Pattern to follow for EUR documentation.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>packages/database/prisma/schema.prisma</path>
        <kind>schema</kind>
        <symbol>Quote, Invoice, InvoiceLine, OrganizationPricingSettings</symbol>
        <lines>942-1089</lines>
        <reason>Models with monetary Decimal fields that need EUR consistency validation. Invoice has currency field defaulting to EUR.</reason>
      </artifact>
      <artifact>
        <path>packages/database/prisma/schema.prisma</path>
        <kind>schema</kind>
        <symbol>VehicleCategory, ZoneRoute, ExcursionPackage, DispoPackage</symbol>
        <lines>373-739</lines>
        <reason>Pricing-related models with Decimal monetary fields (priceMultiplier, fixedPrice, basePrice, overageRates).</reason>
      </artifact>
      <artifact>
        <path>packages/database/prisma/schema.prisma</path>
        <kind>schema</kind>
        <symbol>OptionalFee, Promotion, AdvancedRate</symbol>
        <lines>767-900</lines>
        <reason>Configuration models with monetary amounts and value fields.</reason>
      </artifact>
      <artifact>
        <path>packages/api/src/routes/vtc/quotes.ts</path>
        <kind>router</kind>
        <symbol>quotesRouter</symbol>
        <reason>Existing quotes API with monetary response fields - add EUR documentation to Zod schemas.</reason>
      </artifact>
      <artifact>
        <path>packages/api/src/lib/tenant-prisma.ts</path>
        <kind>utility</kind>
        <symbol>withTenantCreate, withTenantFilter</symbol>
        <reason>Pattern for utility file structure in packages/api/src/lib/.</reason>
      </artifact>
      <artifact>
        <path>packages/api/src/routes/vtc/contacts.ts</path>
        <kind>router</kind>
        <symbol>contactsRouter</symbol>
        <reason>Example of Zod schema with describeRoute for OpenAPI documentation.</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package>decimal.js</package>
        <reason>Decimal arithmetic for precise monetary calculations</reason>
      </node>
      <node>
        <package>@prisma/client</package>
        <reason>Prisma Decimal type for database fields</reason>
      </node>
      <node>
        <package>zod</package>
        <reason>Schema validation with description for OpenAPI</reason>
      </node>
      <node>
        <package>hono-openapi</package>
        <reason>OpenAPI documentation generation</reason>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>All monetary amounts MUST be in EUR - no currency conversion logic allowed</constraint>
    <constraint>Use Decimal type (@db.Decimal) for all monetary fields in Prisma</constraint>
    <constraint>Frontend display MUST use French locale formatting (comma as decimal separator)</constraint>
    <constraint>Invoice.currency field MUST default to "EUR" and be immutable</constraint>
    <constraint>API responses MUST document "Amount in EUR" in OpenAPI descriptions</constraint>
    <constraint>FuelPriceCache MUST store prices in EUR (fetched with currency=EUR parameter)</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>formatEUR</name>
      <kind>utility function</kind>
      <signature>(amount: Decimal | number | string) =&gt; string</signature>
      <path>packages/api/src/lib/currency.ts</path>
    </interface>
    <interface>
      <name>parseEUR</name>
      <kind>utility function</kind>
      <signature>(input: string) =&gt; Decimal</signature>
      <path>packages/api/src/lib/currency.ts</path>
    </interface>
    <interface>
      <name>CURRENCY_CODE</name>
      <kind>constant</kind>
      <signature>"EUR" as const</signature>
      <path>packages/api/src/lib/currency.ts</path>
    </interface>
    <interface>
      <name>EURDisplay</name>
      <kind>React component</kind>
      <signature>({ amount, className }: { amount: number | string | null; className?: string }) =&gt; JSX.Element</signature>
      <path>apps/web/app/_components/currency/EURDisplay.tsx</path>
    </interface>
    <interface>
      <name>EURInput</name>
      <kind>React component</kind>
      <signature>({ value, onChange, ...props }: EURInputProps) =&gt; JSX.Element</signature>
      <path>apps/web/app/_components/currency/EURInput.tsx</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Use existing testing patterns. Unit tests for currency utilities. Component tests for EURDisplay/EURInput. Validate Decimal precision in formatting.</standards>
    <locations>
      <location>packages/api/src/lib/__tests__/</location>
      <location>apps/web/app/_components/currency/__tests__/</location>
    </locations>
    <ideas>
      <idea acId="AC1">Test formatEUR handles Decimal, number, and string inputs correctly</idea>
      <idea acId="AC2">Test EURDisplay renders French locale format (1 234,56 €)</idea>
      <idea acId="AC2">Test EURInput validates numeric input and formats on blur</idea>
      <idea acId="AC3">Verify OpenAPI spec includes EUR documentation for monetary endpoints</idea>
      <idea acId="AC4">Test Invoice.currency defaults to EUR and cannot be changed</idea>
    </ideas>
  </tests>
</story-context>
