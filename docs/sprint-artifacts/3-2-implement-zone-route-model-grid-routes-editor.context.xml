<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story-id>3.2</story-id>
    <story-name>Implement ZoneRoute Model & Grid Routes Editor</story-name>
    <epic>Epic 3 – Zone Engine & Partner Fixed Grids (Method 1)</epic>
    <created>2025-11-26</created>
    <status>ready-for-dev</status>
  </metadata>

  <problem-statement>
    <description>
      Les zones géographiques (PricingZone) sont maintenant définies (Story 3.1), mais il n'existe
      pas encore d'interface pour créer des routes tarifaires entre ces zones. Les partenaires B2B
      ont besoin de prix fixes pour les transferts aéroports (CDG, Orly) et inter-zones.
      
      Sans routes configurées :
      - Le pricing engine ne peut pas appliquer Method 1 (grilles fixes)
      - Les contrats partenaires ne peuvent pas être honorés
      - Les opérateurs doivent calculer manuellement les prix des transferts
    </description>
    <business-impact>
      - Impossibilité d'honorer les engagements contractuels avec les partenaires
      - Risque de pricing incohérent pour les transferts récurrents
      - Perte de temps opérateur sur des calculs manuels
    </business-impact>
  </problem-statement>

  <objectives>
    <primary>
      Créer une interface d'administration permettant de définir des routes zone-à-zone
      avec prix fixes par catégorie de véhicule, direction et statut.
    </primary>
    <secondary>
      - Exposer une API CRUD complète pour les routes
      - Permettre le filtrage par zone, catégorie, direction et statut
      - Afficher le nombre de routes par zone dans la liste des zones
      - Préparer l'intégration avec le pricing engine (Story 3.4)
    </secondary>
  </objectives>

  <scope>
    <in-scope>
      - API REST CRUD : GET/POST/PATCH/DELETE /api/vtc/pricing/routes
      - UI d'administration : liste des routes avec tableau filtrable
      - UI d'édition : formulaire avec sélection zones, catégorie, direction, prix
      - Validation : unicité (fromZone, toZone, vehicleCategory, direction)
      - Filtres : par zone (from/to), catégorie, direction, statut actif
      - Tests unitaires et E2E
    </in-scope>
    <out-of-scope>
      - Intégration avec le pricing engine (Story 3.4)
      - Assignation des routes aux contrats partenaires (déjà prévu via junction table)
      - Excursion et Dispo packages (Story 3.3)
      - Visualisation de couverture des grilles (Story 3.6)
    </out-of-scope>
  </scope>

  <constraints>
    <technical>
      - Le modèle ZoneRoute existe déjà dans le schéma Prisma
      - Multi-tenancy : toutes les routes scoped par organizationId
      - Relations : fromZone, toZone (PricingZone), vehicleCategory (VehicleCategory)
      - Direction enum : BIDIRECTIONAL, A_TO_B, B_TO_A
    </technical>
    <business>
      - FR7 : Dual pricing modes (routes sont la base de Method 1)
      - FR9 : Routes zone-à-zone avec prix fixes
      - FR11 : Engagement Rule - prix contractuels garantis
      - FR37 : Admin configuration pour zones, routes, grids
    </business>
  </constraints>

  <risks>
    <risk priority="medium">
      <description>Doublons de routes avec directions différentes</description>
      <mitigation>Validation côté API pour éviter les conflits logiques 
      (ex: A→B + B→A vs BIDIRECTIONAL).</mitigation>
    </risk>
    <risk priority="low">
      <description>Performance avec beaucoup de routes</description>
      <mitigation>Pagination et index sur (fromZoneId, toZoneId, vehicleCategoryId).</mitigation>
    </risk>
  </risks>

  <acceptance-criteria>
    <criterion id="AC1">
      Given /app/[orgSlug]/routes (ou /zones avec onglet Routes),
      When I open the page,
      Then I see a table of existing routes with columns: From Zone, To Zone, Vehicle Category, 
      Direction (Bidirectional/A→B/B→A), Fixed Price (EUR), Status, Actions.
    </criterion>
    <criterion id="AC2">
      Given I click "Add Route",
      When the form opens,
      Then I can select: From Zone, To Zone, Vehicle Category, Direction, Fixed Price (EUR),
      and toggle Active status.
    </criterion>
    <criterion id="AC3">
      Given I fill the route form and submit,
      When the route is created,
      Then a ZoneRoute record is persisted with organizationId, and the route appears in the table.
    </criterion>
    <criterion id="AC4">
      Given an existing route,
      When I edit and save changes,
      Then the route is updated in the database and the table reflects the changes.
    </criterion>
    <criterion id="AC5">
      Given an existing route,
      When I delete the route,
      Then the route is removed from the database.
    </criterion>
    <criterion id="AC6">
      Given the routes table,
      When I filter by From Zone, To Zone, Vehicle Category, or Status,
      Then the table shows only matching routes.
    </criterion>
    <criterion id="AC7">
      Given the routes API,
      When I call GET /api/vtc/pricing/routes,
      Then I receive a paginated list of routes for the current organization with zone and category details.
    </criterion>
  </acceptance-criteria>

  <dependencies>
    <dependency type="required" status="done">
      Story 3.1 – Implement PricingZone Model & Zones Editor UI
    </dependency>
    <dependency type="required" status="done">
      Story 1.1 – Define VTC ERP Prisma Models (VehicleCategory)
    </dependency>
    <dependency type="required" status="done">
      Story 1.2 – Enforce Organization-Level Multi-Tenancy
    </dependency>
    <dependency type="optional" status="pending">
      Story 2.2 – Partner contracts can reference routes via junction table
    </dependency>
  </dependencies>

  <technical-notes>
    <note>
      ZoneRoute model fields (already in schema):
      - id, organizationId
      - fromZoneId, toZoneId (PricingZone relations)
      - vehicleCategoryId (VehicleCategory relation)
      - direction: RouteDirection (BIDIRECTIONAL, A_TO_B, B_TO_A)
      - fixedPrice: Decimal (EUR)
      - isActive: Boolean
      - createdAt, updatedAt
    </note>
    <note>
      API routes: /api/vtc/pricing/routes (CRUD)
      UI route: /app/[orgSlug]/routes (or tab in zones page)
    </note>
    <note>
      Index exists on (fromZoneId, toZoneId) and (vehicleCategoryId) for efficient lookups.
    </note>
  </technical-notes>

  <artifacts>
    <prd-reference>docs/bmad/prd.md – FR7, FR9, FR11, FR37</prd-reference>
    <epic-reference>docs/bmad/epics.md – Epic 3, Story 3.2</epic-reference>
    <schema-reference>packages/database/prisma/schema.prisma – ZoneRoute (lines 724-752)</schema-reference>
  </artifacts>
</story-context>
