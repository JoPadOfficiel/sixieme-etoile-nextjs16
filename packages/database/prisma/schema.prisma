datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

generator zod {
  provider         = "zod-prisma-types"
  output           = "../src/zod"
  createInputTypes = false
  addIncludeType   = false
  addSelectType    = false
}

model User {
  id                 String       @id
  name               String
  email              String
  emailVerified      Boolean
  image              String?
  createdAt          DateTime
  updatedAt          DateTime
  username           String?
  role               String?
  banned             Boolean?
  banReason          String?
  banExpires         DateTime?
  onboardingComplete Boolean      @default(false)
  locale             String?
  sessions           Session[]
  accounts           Account[]
  passkeys           Passkey[]
  invitations        Invitation[]
  purchases          Purchase[]
  memberships        Member[]

  @@unique([email])
  @@unique([username])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  impersonatedBy String?

  activeOrganizationId String?

  token     String
  createdAt DateTime
  updatedAt DateTime

  @@unique([token])
  @@map("session")
}

model Account {
  id           String    @id
  accountId    String
  providerId   String
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken  String?
  refreshToken String?
  idToken      String?
  expiresAt    DateTime?
  password     String?

  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  createdAt             DateTime
  updatedAt             DateTime

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime

  createdAt DateTime?
  updatedAt DateTime?

  @@map("verification")
}

model Passkey {
  id             String    @id
  name           String?
  publicKey      String
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  webauthnUserID String
  counter        Int
  deviceType     String
  backedUp       Boolean
  transports     String?
  createdAt      DateTime?

  @@map("passkey")
}

model Organization {
  id          String       @id
  name        String
  slug        String?
  logo        String?
  createdAt   DateTime
  metadata    String?
  members     Member[]
  invitations Invitation[]
  purchases   Purchase[]

  // VTC ERP Relations
  contacts                    Contact[]
  vehicleCategories           VehicleCategory[]
  operatingBases              OperatingBase[]
  vehicles                    Vehicle[]
  licenseCategories           LicenseCategory[]
  organizationLicenseRules    OrganizationLicenseRule[]
  drivers                     Driver[]
  pricingZones                PricingZone[]
  zoneRoutes                  ZoneRoute[]
  excursionPackages           ExcursionPackage[]
  dispoPackages               DispoPackage[]
  organizationPricingSettings OrganizationPricingSettings?
  advancedRates               AdvancedRate[]
  seasonalMultipliers         SeasonalMultiplier[]
  optionalFees                OptionalFee[]
  promotions                  Promotion[]
  emptyLegOpportunities       EmptyLegOpportunity[]
  quotes                      Quote[]
  invoices                    Invoice[]
  documents                   Document[]
  integrationSettings         OrganizationIntegrationSettings?
  partnerContracts            PartnerContract[]
  subcontractorProfiles       SubcontractorProfile[]
  driverRSECounters           DriverRSECounter[]
  complianceAuditLogs         ComplianceAuditLog[]
  quoteStatusAuditLogs        QuoteStatusAuditLog[]

  @@unique([slug])
  @@map("organization")
}

model Member {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String
  createdAt      DateTime

  @@unique([userId, organizationId])
  @@map("member")
}

model Invitation {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String
  expiresAt      DateTime
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@map("invitation")
}

enum PurchaseType {
  SUBSCRIPTION
  ONE_TIME
}

// ============================================================================
// VTC ERP ENUMS
// ============================================================================

/// Contact type for CRM - distinguishes individuals, businesses, and agencies
enum ContactType {
  INDIVIDUAL
  BUSINESS
  AGENCY
}

/// Client type for pricing rules - partner clients get fixed grids, private get dynamic pricing
enum ClientType {
  PARTNER
  PRIVATE
}

/// Vehicle regulatory category - determines RSE constraints and driver requirements
enum VehicleRegulatoryCategory {
  LIGHT
  HEAVY
}

/// Vehicle operational status
enum VehicleStatus {
  ACTIVE
  MAINTENANCE
  OUT_OF_SERVICE
}

/// Driver employment status
enum DriverEmploymentStatus {
  EMPLOYEE
  CONTRACTOR
  FREELANCE
}

/// Quote lifecycle status
enum QuoteStatus {
  DRAFT
  SENT
  VIEWED
  ACCEPTED
  REJECTED
  EXPIRED
}

/// Invoice lifecycle status
enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  CANCELLED
}

/// Pricing mode - Method 1 (fixed grids) vs Method 2 (dynamic)
enum PricingMode {
  FIXED_GRID
  DYNAMIC
}

/// Trip type classification
enum TripType {
  TRANSFER
  EXCURSION
  DISPO
  OFF_GRID
}

/// Amount type for fees and discounts
enum AmountType {
  FIXED
  PERCENTAGE
}

/// Adjustment type for advanced rates
enum AdjustmentType {
  PERCENTAGE
  FIXED_AMOUNT
}

/// Zone type for geographic definitions
enum ZoneType {
  POLYGON
  RADIUS
  POINT
}

/// Route direction for zone-to-zone pricing
enum RouteDirection {
  BIDIRECTIONAL
  A_TO_B
  B_TO_A
}

/// Advanced rate application scope
enum AdvancedRateAppliesTo {
  NIGHT
  WEEKEND
  LONG_DISTANCE
  ZONE_SCENARIO
  HOLIDAY
}

/// Fuel type for price cache
enum FuelType {
  GASOLINE
  DIESEL
  LPG
}

/// Invoice line type
enum InvoiceLineType {
  SERVICE
  OPTIONAL_FEE
  PROMOTION_ADJUSTMENT
  OTHER
}

/// Payment terms for partner contracts
enum PaymentTerms {
  IMMEDIATE
  DAYS_15
  DAYS_30
  DAYS_45
  DAYS_60
}

model Purchase {
  id             String        @id @default(cuid())
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String?
  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String?
  type           PurchaseType
  customerId     String
  subscriptionId String?       @unique
  productId      String
  status         String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([subscriptionId])
}

// ============================================================================
// VTC ERP MODELS
// ============================================================================

// ----------------------------------------------------------------------------
// CORE TENANCY & CRM
// ----------------------------------------------------------------------------

/// Contact - Unifies private customers, corporate clients, and agencies
model Contact {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Contact type
  type        ContactType @default(INDIVIDUAL)
  displayName String

  // Person fields
  firstName String?
  lastName  String?
  email     String?
  phone     String?

  // Company fields
  companyName    String?
  vatNumber      String?
  siret          String?
  billingAddress String?

  // Commercial flags
  isPartner         Boolean    @default(false)
  isSubcontractor   Boolean    @default(false)
  defaultClientType ClientType @default(PRIVATE)

  // Metadata
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  quotes               Quote[]
  invoices             Invoice[]
  partnerContract      PartnerContract?
  subcontractorProfile SubcontractorProfile?

  @@index([organizationId])
  @@index([email])
  @@index([isPartner])
  @@index([isSubcontractor])
  @@map("contact")
}

/// PartnerContract - Commercial settings for partner contacts
model PartnerContract {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Link to Contact (1:1)
  contactId String  @unique
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Billing (optional override)
  billingAddress String?

  // Payment terms
  paymentTerms PaymentTerms @default(DAYS_30)

  // Commission
  commissionPercent Decimal @default(0) @db.Decimal(5, 2) // 0.00 to 100.00

  // Metadata
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Grid assignments (many-to-many)
  zoneRoutes        PartnerContractZoneRoute[]
  excursionPackages PartnerContractExcursionPackage[]
  dispoPackages     PartnerContractDispoPackage[]

  @@index([organizationId])
  @@index([contactId])
  @@map("partner_contract")
}

/// Junction table: PartnerContract <-> ZoneRoute
model PartnerContractZoneRoute {
  id                String          @id @default(cuid())
  partnerContractId String
  partnerContract   PartnerContract @relation(fields: [partnerContractId], references: [id], onDelete: Cascade)
  zoneRouteId       String
  zoneRoute         ZoneRoute       @relation(fields: [zoneRouteId], references: [id], onDelete: Cascade)

  @@unique([partnerContractId, zoneRouteId])
  @@map("partner_contract_zone_route")
}

/// Junction table: PartnerContract <-> ExcursionPackage
model PartnerContractExcursionPackage {
  id                 String           @id @default(cuid())
  partnerContractId  String
  partnerContract    PartnerContract  @relation(fields: [partnerContractId], references: [id], onDelete: Cascade)
  excursionPackageId String
  excursionPackage   ExcursionPackage @relation(fields: [excursionPackageId], references: [id], onDelete: Cascade)

  @@unique([partnerContractId, excursionPackageId])
  @@map("partner_contract_excursion_package")
}

/// Junction table: PartnerContract <-> DispoPackage
model PartnerContractDispoPackage {
  id                String          @id @default(cuid())
  partnerContractId String
  partnerContract   PartnerContract @relation(fields: [partnerContractId], references: [id], onDelete: Cascade)
  dispoPackageId    String
  dispoPackage      DispoPackage    @relation(fields: [dispoPackageId], references: [id], onDelete: Cascade)

  @@unique([partnerContractId, dispoPackageId])
  @@map("partner_contract_dispo_package")
}

// ----------------------------------------------------------------------------
// SUBCONTRACTOR MODELS (Story 8.6)
// ----------------------------------------------------------------------------

/// SubcontractorProfile - Details for subcontractor contacts
model SubcontractorProfile {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Link to Contact (1:1)
  contactId String  @unique
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Indicative pricing (EUR)
  ratePerKm   Decimal? @db.Decimal(8, 2)
  ratePerHour Decimal? @db.Decimal(8, 2)
  minimumFare Decimal? @db.Decimal(8, 2)

  // Status
  isActive Boolean @default(true)
  notes    String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  operatingZones      SubcontractorZone[]
  vehicleCategories   SubcontractorVehicleCategory[]
  subcontractedQuotes Quote[]

  @@index([organizationId])
  @@index([contactId])
  @@index([isActive])
  @@map("subcontractor_profile")
}

/// SubcontractorZone - Junction: SubcontractorProfile <-> PricingZone
model SubcontractorZone {
  id                     String               @id @default(cuid())
  subcontractorProfileId String
  subcontractorProfile   SubcontractorProfile @relation(fields: [subcontractorProfileId], references: [id], onDelete: Cascade)
  pricingZoneId          String
  pricingZone            PricingZone          @relation(fields: [pricingZoneId], references: [id], onDelete: Cascade)

  @@unique([subcontractorProfileId, pricingZoneId])
  @@map("subcontractor_zone")
}

/// SubcontractorVehicleCategory - Junction: SubcontractorProfile <-> VehicleCategory
model SubcontractorVehicleCategory {
  id                     String               @id @default(cuid())
  subcontractorProfileId String
  subcontractorProfile   SubcontractorProfile @relation(fields: [subcontractorProfileId], references: [id], onDelete: Cascade)
  vehicleCategoryId      String
  vehicleCategory        VehicleCategory      @relation(fields: [vehicleCategoryId], references: [id], onDelete: Cascade)

  @@unique([subcontractorProfileId, vehicleCategoryId])
  @@map("subcontractor_vehicle_category")
}

// ----------------------------------------------------------------------------
// FLEET & REGULATORY MODELS
// ----------------------------------------------------------------------------

/// VehicleCategory - Groups vehicles by commercial and regulatory category
model VehicleCategory {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Identification
  name String
  code String

  // Regulatory
  regulatoryCategory VehicleRegulatoryCategory @default(LIGHT)

  // Capacity
  maxPassengers    Int
  maxLuggageVolume Int? // in liters

  // Pricing multipliers
  priceMultiplier    Decimal  @default(1.0) @db.Decimal(5, 2)
  defaultRatePerKm   Decimal? @db.Decimal(10, 4)
  defaultRatePerHour Decimal? @db.Decimal(10, 2)

  // Metadata
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  vehicles                       Vehicle[]
  zoneRoutes                     ZoneRoute[]
  excursionPackages              ExcursionPackage[]
  dispoPackages                  DispoPackage[]
  quotes                         Quote[]
  subcontractorVehicleCategories SubcontractorVehicleCategory[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@map("vehicle_category")
}

/// OperatingBase - Physical bases/garages for multi-base model
model OperatingBase {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Identification
  name String

  // Address
  addressLine1 String
  addressLine2 String?
  city         String
  postalCode   String
  countryCode  String  @default("FR")

  // Coordinates for Google Maps
  latitude  Decimal @db.Decimal(10, 7)
  longitude Decimal @db.Decimal(10, 7)

  // Metadata
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  vehicles Vehicle[]

  @@index([organizationId])
  @@map("operating_base")
}

/// Vehicle - Individual fleet vehicles
model Vehicle {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Category and base
  vehicleCategoryId String
  vehicleCategory   VehicleCategory @relation(fields: [vehicleCategoryId], references: [id])
  operatingBaseId   String
  operatingBase     OperatingBase   @relation(fields: [operatingBaseId], references: [id])

  // Identification
  registrationNumber String
  internalName       String?
  vin                String?

  // Capacity
  passengerCapacity Int
  luggageCapacity   Int? // in liters

  // Cost drivers
  consumptionLPer100Km Decimal? @db.Decimal(5, 2)
  averageSpeedKmh      Int?
  costPerKm            Decimal? @db.Decimal(10, 4)

  // Regulatory - required license
  requiredLicenseCategoryId String?
  requiredLicenseCategory   LicenseCategory? @relation(fields: [requiredLicenseCategoryId], references: [id])

  // Status
  status VehicleStatus @default(ACTIVE)

  // Metadata
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  emptyLegOpportunities EmptyLegOpportunity[]
  assignedQuotes        Quote[]               @relation("AssignedVehicle")
  quotes                Quote[]

  @@unique([organizationId, registrationNumber])
  @@index([organizationId])
  @@index([vehicleCategoryId])
  @@index([operatingBaseId])
  @@index([status])
  @@map("vehicle")
}

/// LicenseCategory - Encodes license types (B, D, D_CMI, etc.)
model LicenseCategory {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Identification
  code        String
  name        String
  description String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationRules     OrganizationLicenseRule[]
  vehiclesRequiringThis Vehicle[]
  driverLicenses        DriverLicense[]
  driverRSECounters     DriverRSECounter[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@map("license_category")
}

/// OrganizationLicenseRule - RSE limits per license type (zero-hardcoding)
model OrganizationLicenseRule {
  id                String          @id @default(cuid())
  organizationId    String
  organization      Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  licenseCategoryId String
  licenseCategory   LicenseCategory @relation(fields: [licenseCategoryId], references: [id])

  // RSE constraints
  maxDailyDrivingHours        Decimal @db.Decimal(4, 2) // e.g. 10.00
  maxDailyAmplitudeHours      Decimal @db.Decimal(4, 2) // e.g. 14.00 or 18.00 with double crew
  breakMinutesPerDrivingBlock Int // e.g. 45
  drivingBlockHoursForBreak   Decimal @db.Decimal(4, 2) // e.g. 4.50
  cappedAverageSpeedKmh       Int? // e.g. 85 for heavy vehicles

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, licenseCategoryId])
  @@index([organizationId])
  @@map("organization_license_rule")
}

/// Driver - Driver profiles with cost information
model Driver {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Person data
  firstName String
  lastName  String
  email     String?
  phone     String?

  // HR data
  employmentStatus DriverEmploymentStatus @default(EMPLOYEE)
  hourlyCost       Decimal?               @db.Decimal(10, 2)

  // Status
  isActive Boolean @default(true)

  // Metadata
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  driverLicenses      DriverLicense[]
  driverRSECounters   DriverRSECounter[]
  complianceAuditLogs ComplianceAuditLog[]
  assignedQuotes      Quote[]              @relation("AssignedDriver")
  quotes              Quote[]

  @@index([organizationId])
  @@index([isActive])
  @@map("driver")
}

/// DriverLicense - Junction between Driver and LicenseCategory
model DriverLicense {
  id                String          @id @default(cuid())
  driverId          String
  driver            Driver          @relation(fields: [driverId], references: [id], onDelete: Cascade)
  licenseCategoryId String
  licenseCategory   LicenseCategory @relation(fields: [licenseCategoryId], references: [id])

  // License details
  licenseNumber String
  validFrom     DateTime
  validTo       DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([driverId, licenseCategoryId])
  @@index([driverId])
  @@index([licenseCategoryId])
  @@map("driver_license")
}

// ----------------------------------------------------------------------------
// PRICING, ZONES & GRIDS
// ----------------------------------------------------------------------------

/// PricingZone - Geographic zones (central Paris, rings, satellites)
model PricingZone {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Identification
  name String
  code String

  // Zone definition
  zoneType        ZoneType @default(POLYGON)
  geometry        Json? // GeoJSON-like structure
  centerLatitude  Decimal? @db.Decimal(10, 7)
  centerLongitude Decimal? @db.Decimal(10, 7)
  radiusKm        Decimal? @db.Decimal(10, 2) // For RADIUS type zones

  // Hierarchy
  parentZoneId String?
  parentZone   PricingZone?  @relation("ZoneHierarchy", fields: [parentZoneId], references: [id])
  childZones   PricingZone[] @relation("ZoneHierarchy")

  // Metadata
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  fromRoutes            ZoneRoute[]           @relation("FromZone")
  toRoutes              ZoneRoute[]           @relation("ToZone")
  excursionOrigins      ExcursionPackage[]    @relation("ExcursionOrigin")
  excursionDestinations ExcursionPackage[]    @relation("ExcursionDestination")
  advancedRates         AdvancedRate[]
  emptyLegFrom          EmptyLegOpportunity[] @relation("EmptyLegFrom")
  emptyLegTo            EmptyLegOpportunity[] @relation("EmptyLegTo")
  subcontractorZones    SubcontractorZone[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@map("pricing_zone")
}

/// ZoneRoute - Method 1 zone-to-zone fixed pricing for transfers
model ZoneRoute {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Route definition
  fromZoneId        String
  fromZone          PricingZone     @relation("FromZone", fields: [fromZoneId], references: [id])
  toZoneId          String
  toZone            PricingZone     @relation("ToZone", fields: [toZoneId], references: [id])
  vehicleCategoryId String
  vehicleCategory   VehicleCategory @relation(fields: [vehicleCategoryId], references: [id])

  // Pricing
  direction  RouteDirection @default(BIDIRECTIONAL)
  fixedPrice Decimal        @db.Decimal(10, 2) // EUR

  // Status
  isActive                  Boolean                    @default(true)
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  partnerContractZoneRoutes PartnerContractZoneRoute[]

  @@index([organizationId])
  @@index([fromZoneId, toZoneId])
  @@index([vehicleCategoryId])
  @@map("zone_route")
}

/// ExcursionPackage - Forfaits for excursions (Normandy, Loire Valley, etc.)
model ExcursionPackage {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Package details
  name        String
  description String?

  // Zones
  originZoneId      String?
  originZone        PricingZone? @relation("ExcursionOrigin", fields: [originZoneId], references: [id])
  destinationZoneId String?
  destinationZone   PricingZone? @relation("ExcursionDestination", fields: [destinationZoneId], references: [id])

  // Vehicle category
  vehicleCategoryId String
  vehicleCategory   VehicleCategory @relation(fields: [vehicleCategoryId], references: [id])

  // Included service
  includedDurationHours Decimal @db.Decimal(5, 2)
  includedDistanceKm    Decimal @db.Decimal(8, 2)

  // Pricing
  price Decimal @db.Decimal(10, 2) // EUR

  // Status
  isActive                         Boolean                           @default(true)
  createdAt                        DateTime                          @default(now())
  updatedAt                        DateTime                          @updatedAt
  partnerContractExcursionPackages PartnerContractExcursionPackage[]

  @@index([organizationId])
  @@index([vehicleCategoryId])
  @@map("excursion_package")
}

/// DispoPackage - Forfaits de mise Ã  disposition (hourly dispos)
model DispoPackage {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Package details
  name        String
  description String?

  // Vehicle category
  vehicleCategoryId String
  vehicleCategory   VehicleCategory @relation(fields: [vehicleCategoryId], references: [id])

  // Included service
  includedDurationHours Decimal @db.Decimal(5, 2)
  includedDistanceKm    Decimal @db.Decimal(8, 2)

  // Pricing
  basePrice          Decimal @db.Decimal(10, 2) // EUR
  overageRatePerKm   Decimal @db.Decimal(10, 4) // EUR per km
  overageRatePerHour Decimal @db.Decimal(10, 2) // EUR per hour

  // Status
  isActive                     Boolean                       @default(true)
  createdAt                    DateTime                      @default(now())
  updatedAt                    DateTime                      @updatedAt
  partnerContractDispoPackages PartnerContractDispoPackage[]

  @@index([organizationId])
  @@index([vehicleCategoryId])
  @@map("dispo_package")
}

/// OrganizationPricingSettings - Base commercial parameters per organisation
model OrganizationPricingSettings {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Base rates
  baseRatePerKm   Decimal @db.Decimal(10, 4) // EUR per km
  baseRatePerHour Decimal @db.Decimal(10, 2) // EUR per hour

  // Margin settings
  defaultMarginPercent Decimal @db.Decimal(5, 2) // e.g. 20.00 for 20%

  // Story 4.7: Profitability indicator thresholds (configurable)
  // Green threshold: margin >= this value is "green" (profitable)
  greenMarginThreshold  Decimal @default(20.00) @db.Decimal(5, 2) // Default 20%
  // Orange threshold: margin >= this value (but < green) is "orange" (low margin)
  // Below this threshold is "red" (loss)
  orangeMarginThreshold Decimal @default(0.00) @db.Decimal(5, 2) // Default 0%

  // Minimum fare
  minimumFare Decimal @db.Decimal(10, 2) // EUR

  // Rounding rule (optional)
  roundingRule String? // e.g. "NEAREST_5", "NEAREST_10"

  // Story 4.2: Operational cost parameters (optional, defaults in pricing-engine.ts)
  fuelConsumptionL100km Decimal? @db.Decimal(5, 2) // Liters per 100km (e.g., 8.0)
  fuelPricePerLiter     Decimal? @db.Decimal(5, 2) // EUR per liter (e.g., 1.80)
  tollCostPerKm         Decimal? @db.Decimal(5, 4) // EUR per km (e.g., 0.15)
  wearCostPerKm         Decimal? @db.Decimal(5, 4) // EUR per km (e.g., 0.10)
  driverHourlyCost      Decimal? @db.Decimal(8, 2) // EUR per hour (e.g., 25.00)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("organization_pricing_settings")
}

/// AdvancedRate - Advanced modifiers (night, weekend, long-distance, zone-based)
model AdvancedRate {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Identification
  name String

  // Application scope
  appliesTo AdvancedRateAppliesTo

  // Time conditions (for NIGHT, WEEKEND, HOLIDAY)
  startTime  String? // HH:MM format
  endTime    String? // HH:MM format
  daysOfWeek String? // e.g. "1,2,3,4,5" for weekdays

  // Distance conditions (for LONG_DISTANCE)
  minDistanceKm Decimal? @db.Decimal(8, 2)
  maxDistanceKm Decimal? @db.Decimal(8, 2)

  // Zone conditions (for ZONE_SCENARIO)
  zoneId String?
  zone   PricingZone? @relation(fields: [zoneId], references: [id])

  // Adjustment
  adjustmentType AdjustmentType
  value          Decimal        @db.Decimal(10, 4) // percentage or fixed amount

  // Priority for stacking
  priority Int @default(0)

  // Status
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([appliesTo])
  @@map("advanced_rate")
}

/// SeasonalMultiplier - Seasonal or event-based multipliers
model SeasonalMultiplier {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Identification
  name        String
  description String?

  // Date range
  startDate DateTime
  endDate   DateTime

  // Multiplier
  multiplier Decimal @db.Decimal(5, 3) // e.g. 1.300 for 30% increase

  // Priority for overlapping periods
  priority Int @default(0)

  // Status
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([startDate, endDate])
  @@map("seasonal_multiplier")
}

/// OptionalFee - Catalogue of optional fees (baby seat, waiting, cleaning)
model OptionalFee {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Identification
  name        String
  description String?

  // Amount
  amountType AmountType
  amount     Decimal    @db.Decimal(10, 4) // EUR or percentage

  // Tax
  isTaxable Boolean @default(true)
  vatRate   Decimal @default(20.0) @db.Decimal(5, 2) // e.g. 20.00 for 20%

  // Auto-apply rules (JSON conditions)
  autoApplyRules Json?

  // Status
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@map("optional_fee")
}

/// Promotion - Promo codes and discounts
model Promotion {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Identification
  code        String
  description String?

  // Discount
  discountType AmountType
  value        Decimal    @db.Decimal(10, 4) // EUR or percentage

  // Validity
  validFrom DateTime
  validTo   DateTime

  // Usage limits
  maxTotalUses      Int?
  maxUsesPerContact Int?
  currentUses       Int  @default(0)

  // Status
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([validFrom, validTo])
  @@map("promotion")
}

/// EmptyLegOpportunity - Empty-leg segments that can be sold with special strategies (Story 8.5)
model EmptyLegOpportunity {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Vehicle
  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id])

  // Route - Zone-based (optional)
  fromZoneId String?
  fromZone   PricingZone? @relation("EmptyLegFrom", fields: [fromZoneId], references: [id])
  toZoneId   String?
  toZone     PricingZone? @relation("EmptyLegTo", fields: [toZoneId], references: [id])

  // Route - Address-based (Story 8.5)
  fromAddress   String?
  fromLatitude  Decimal? @db.Decimal(10, 7)
  fromLongitude Decimal? @db.Decimal(10, 7)
  toAddress     String?
  toLatitude    Decimal? @db.Decimal(10, 7)
  toLongitude   Decimal? @db.Decimal(10, 7)

  // Estimated metrics (Story 8.5)
  estimatedDistanceKm   Decimal? @db.Decimal(8, 2)
  estimatedDurationMins Int?

  // Time window
  windowStart DateTime
  windowEnd   DateTime

  // Pricing strategy (JSON)
  // Example: { "type": "PERCENTAGE_DISCOUNT", "value": 30 }
  // Example: { "type": "FIXED_PRICE", "value": 50 }
  // Example: { "type": "COST_PLUS_MARGIN", "marginPercent": 10 }
  pricingStrategy Json?

  // Source mission reference (Story 8.5)
  sourceMissionId String?

  // Status
  isActive Boolean @default(true)

  // Metadata
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([vehicleId])
  @@index([windowStart, windowEnd])
  @@index([isActive])
  @@map("empty_leg_opportunity")
}

// ----------------------------------------------------------------------------
// QUOTES, INVOICES & DOCUMENTS
// ----------------------------------------------------------------------------

/// Quote - Central commercial object for pricing and feasibility
model Quote {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Contact
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id])

  // Status
  status QuoteStatus @default(DRAFT)

  // Pricing mode and trip type
  pricingMode PricingMode
  tripType    TripType

  // Pickup details
  pickupAt        DateTime
  pickupAddress   String
  pickupLatitude  Decimal? @db.Decimal(10, 7)
  pickupLongitude Decimal? @db.Decimal(10, 7)

  // Dropoff details
  dropoffAddress   String
  dropoffLatitude  Decimal? @db.Decimal(10, 7)
  dropoffLongitude Decimal? @db.Decimal(10, 7)

  // Passengers and luggage
  passengerCount Int
  luggageCount   Int @default(0)

  // Vehicle category
  vehicleCategoryId String
  vehicleCategory   VehicleCategory @relation(fields: [vehicleCategoryId], references: [id])

  // Monetary fields (EUR only)
  suggestedPrice Decimal  @db.Decimal(10, 2)
  finalPrice     Decimal  @db.Decimal(10, 2)
  internalCost   Decimal? @db.Decimal(10, 2)
  marginPercent  Decimal? @db.Decimal(5, 2)

  // Commission data (Story 7.4)
  commissionPercent Decimal? @db.Decimal(5, 2) // Snapshot from partner contract at quote time
  commissionAmount  Decimal? @db.Decimal(10, 2) // Calculated commission amount

  // Analysis context (JSON)
  tripAnalysis Json? // Shadow calculation: segments A/B/C, distances, durations, cost breakdown
  appliedRules Json? // Which grids, multipliers, promotions, optional fees were used

  // Validity
  validUntil DateTime?

  // Notes
  notes String?

  // Status transition timestamps (Story 6.4)
  sentAt     DateTime?
  viewedAt   DateTime?
  acceptedAt DateTime?
  rejectedAt DateTime?
  expiredAt  DateTime?

  // Assignment fields (Story 8.2)
  assignedVehicleId String?
  assignedVehicle   Vehicle?  @relation("AssignedVehicle", fields: [assignedVehicleId], references: [id])
  assignedDriverId  String?
  assignedDriver    Driver?   @relation("AssignedDriver", fields: [assignedDriverId], references: [id])
  assignedAt        DateTime?

  // Chaining fields (Story 8.4)
  chainId       String? // Shared ID for chained missions (UUID)
  chainOrder    Int? // Order in chain (1, 2, 3...)
  chainedWithId String? // Direct link to next mission in chain
  chainedWith   Quote?  @relation("ChainLink", fields: [chainedWithId], references: [id])
  chainedBy     Quote[] @relation("ChainLink")

  // Subcontracting fields (Story 8.6)
  isSubcontracted     Boolean               @default(false)
  subcontractorId     String?
  subcontractor       SubcontractorProfile? @relation(fields: [subcontractorId], references: [id])
  subcontractedPrice  Decimal?              @db.Decimal(10, 2)
  subcontractedAt     DateTime?
  subcontractingNotes String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  invoice         Invoice?
  statusAuditLogs QuoteStatusAuditLog[]
  documents       Document[]
  vehicle         Vehicle?              @relation(fields: [vehicleId], references: [id])
  vehicleId       String?
  driver          Driver?               @relation(fields: [driverId], references: [id])
  driverId        String?

  @@index([organizationId])
  @@index([contactId])
  @@index([status])
  @@index([pickupAt])
  @@index([assignedVehicleId])
  @@index([assignedDriverId])
  @@index([chainId])
  @@index([isSubcontracted])
  @@index([subcontractorId])
  @@map("quote")
}

/// Invoice - Immutable financial document derived from accepted quotes
model Invoice {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Source quote (optional - can be standalone invoice)
  quoteId String? @unique
  quote   Quote?  @relation(fields: [quoteId], references: [id])

  // Contact
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id])

  // Invoice number (unique per org)
  number String

  // Status
  status InvoiceStatus @default(DRAFT)

  // Dates
  issueDate DateTime
  dueDate   DateTime

  // Totals (EUR only)
  totalExclVat Decimal @db.Decimal(10, 2)
  totalVat     Decimal @db.Decimal(10, 2)
  totalInclVat Decimal @db.Decimal(10, 2)
  currency     String  @default("EUR")

  // Commission (for partner invoices)
  commissionAmount Decimal? @db.Decimal(10, 2)

  // Notes
  notes String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lines     InvoiceLine[]
  documents Document[]

  @@unique([organizationId, number])
  @@index([organizationId])
  @@index([contactId])
  @@index([status])
  @@index([issueDate])
  @@map("invoice")
}

/// InvoiceLine - Line items for services, optional fees, discounts
model InvoiceLine {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Line type
  lineType InvoiceLineType

  // Description
  description String

  // Quantity and pricing
  quantity         Decimal @db.Decimal(10, 3)
  unitPriceExclVat Decimal @db.Decimal(10, 4)
  vatRate          Decimal @db.Decimal(5, 2) // e.g. 20.00 for 20%

  // Computed totals (stored for immutability)
  totalExclVat Decimal @db.Decimal(10, 2)
  totalVat     Decimal @db.Decimal(10, 2)

  // Sort order
  sortOrder Int @default(0)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
  @@map("invoice_line")
}

/// DocumentType - Classify generated documents
model DocumentType {
  id          String  @id @default(cuid())
  code        String  @unique // e.g. QUOTE_PDF, INVOICE_PDF, MISSION_ORDER
  name        String
  description String?

  // Relations
  documents Document[]

  @@map("document_type")
}

/// Document - Store generated artefacts (PDFs, etc.)
model Document {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Document type
  documentTypeId String
  documentType   DocumentType @relation(fields: [documentTypeId], references: [id])

  // Related entities (optional)
  quoteId   String?
  quote     Quote?   @relation(fields: [quoteId], references: [id])
  invoiceId String?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id])

  // Storage
  storagePath String?
  url         String?
  filename    String?

  // Metadata
  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([documentTypeId])
  @@index([quoteId])
  @@index([invoiceId])
  @@map("document")
}

// ----------------------------------------------------------------------------
// FUEL & INTEGRATIONS
// ----------------------------------------------------------------------------

/// FuelPriceCache - Cache layer for fuel prices from CollectAPI
model FuelPriceCache {
  id String @id @default(cuid())

  // Location
  countryCode String  @default("FR")
  latitude    Decimal @db.Decimal(10, 7)
  longitude   Decimal @db.Decimal(10, 7)

  // Fuel type and price
  fuelType      FuelType
  pricePerLitre Decimal  @db.Decimal(10, 4) // EUR
  currency      String   @default("EUR")

  // Source
  source String @default("COLLECT_API")

  // Timestamp
  fetchedAt DateTime

  @@unique([countryCode, fuelType])
  @@index([fetchedAt])
  @@map("fuel_price_cache")
}

/// OrganizationIntegrationSettings - Per-organisation integration settings and API keys
model OrganizationIntegrationSettings {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // API Keys (should be encrypted at rest in production)
  googleMapsApiKey String?
  collectApiKey    String?

  // Preferences
  preferredFuelType String? @default("DIESEL") // DIESEL, GASOLINE, LPG

  // Connection status cache (updated after test)
  googleMapsStatus   String? // connected, invalid, unknown
  googleMapsTestedAt DateTime?
  collectApiStatus   String? // connected, invalid, unknown
  collectApiTestedAt DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("organization_integration_settings")
}

// ----------------------------------------------------------------------------
// RSE COUNTERS & COMPLIANCE AUDIT (Story 5.5)
// ----------------------------------------------------------------------------

/// DriverRSECounter - Tracks RSE counters per driver, per day, per regulatory regime
model DriverRSECounter {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  driverId       String
  driver         Driver       @relation(fields: [driverId], references: [id], onDelete: Cascade)

  // Date (business date in Europe/Paris)
  date DateTime @db.Date

  // Regulatory regime
  regulatoryCategory VehicleRegulatoryCategory
  licenseCategoryId  String?
  licenseCategory    LicenseCategory?          @relation(fields: [licenseCategoryId], references: [id])

  // Counters (in minutes for precision)
  drivingMinutes   Int @default(0)
  amplitudeMinutes Int @default(0)
  breakMinutes     Int @default(0)
  restMinutes      Int @default(0)

  // Work period tracking
  workStartTime DateTime? // First activity start time
  workEndTime   DateTime? // Last activity end time

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, driverId, date, regulatoryCategory])
  @@index([organizationId])
  @@index([driverId])
  @@index([date])
  @@map("driver_rse_counter")
}

/// ComplianceAuditLog - Logs compliance decisions for audit purposes (FR30)
model ComplianceAuditLog {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  driverId       String
  driver         Driver       @relation(fields: [driverId], references: [id], onDelete: Cascade)

  // Timestamp
  timestamp DateTime @default(now())

  // Context
  quoteId            String?
  missionId          String?
  vehicleCategoryId  String?
  regulatoryCategory VehicleRegulatoryCategory

  // Decision
  decision   String // "APPROVED", "BLOCKED", "WARNING"
  violations Json? // Array of ComplianceViolation
  warnings   Json? // Array of ComplianceWarning
  reason     String

  // Counters snapshot at time of decision
  countersSnapshot Json?

  @@index([organizationId])
  @@index([driverId])
  @@index([timestamp])
  @@map("compliance_audit_log")
}

// ----------------------------------------------------------------------------
// QUOTE STATUS AUDIT LOG (Story 6.4)
// ----------------------------------------------------------------------------

/// QuoteStatusAuditLog - Tracks quote status transitions for audit purposes
model QuoteStatusAuditLog {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  quoteId        String
  quote          Quote        @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  // Transition details
  previousStatus QuoteStatus
  newStatus      QuoteStatus

  // Actor
  userId String?

  // Timestamp
  timestamp DateTime @default(now())

  // Optional context/reason
  reason String?

  @@index([organizationId])
  @@index([quoteId])
  @@index([timestamp])
  @@map("quote_status_audit_log")
}
