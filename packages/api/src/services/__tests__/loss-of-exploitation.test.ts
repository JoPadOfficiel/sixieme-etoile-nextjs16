/**
 * Story 18.4: Loss of Exploitation (Opportunity Cost) Calculation Tests
 * 
 * Tests for calculating the opportunity cost when a vehicle is immobilized
 * during multi-day missions.
 */

import { describe, it, expect } from "vitest";
import {
	calculateIdleDays,
	getDailyReferenceRevenue,
	getSeasonalityCoefficient,
	calculateLossOfExploitation,
	buildLossOfExploitationRule,
	DEFAULT_SEASONALITY_COEFFICIENTS,
	type LossOfExploitationResult,
	type DailyRevenueSource,
	type SeasonalityPeriod,
} from "../pricing-engine";

describe("Story 18.4: Loss of Exploitation Calculation", () => {
	// =========================================================================
	// calculateIdleDays() Tests
	// =========================================================================
	describe("calculateIdleDays", () => {
		it("LOE-01: should return 0 idle days for 1-day mission", () => {
			const pickupAt = new Date("2025-07-15T08:00:00");
			const estimatedEndAt = new Date("2025-07-15T18:00:00");
			
			const result = calculateIdleDays(pickupAt, estimatedEndAt);
			
			expect(result.totalDays).toBe(1);
			expect(result.idleDays).toBe(0);
			expect(result.isMultiDay).toBe(false);
		});

		it("LOE-02: should return 0 idle days for 2-day mission", () => {
			const pickupAt = new Date("2025-07-15T08:00:00");
			const estimatedEndAt = new Date("2025-07-16T18:00:00");
			
			const result = calculateIdleDays(pickupAt, estimatedEndAt);
			
			expect(result.totalDays).toBe(2);
			expect(result.idleDays).toBe(0);
			expect(result.isMultiDay).toBe(true);
		});

		it("LOE-03: should return 1 idle day for 3-day mission", () => {
			const pickupAt = new Date("2025-07-15T08:00:00");
			const estimatedEndAt = new Date("2025-07-17T18:00:00");
			
			const result = calculateIdleDays(pickupAt, estimatedEndAt);
			
			expect(result.totalDays).toBe(3);
			expect(result.idleDays).toBe(1);
			expect(result.isMultiDay).toBe(true);
		});

		it("LOE-04: should return 3 idle days for 5-day mission", () => {
			const pickupAt = new Date("2025-07-15T08:00:00");
			const estimatedEndAt = new Date("2025-07-19T18:00:00");
			
			const result = calculateIdleDays(pickupAt, estimatedEndAt);
			
			expect(result.totalDays).toBe(5);
			expect(result.idleDays).toBe(3);
			expect(result.isMultiDay).toBe(true);
		});

		it("should handle same-day mission spanning midnight correctly", () => {
			// Mission starts at 22:00 and ends at 02:00 next day
			const pickupAt = new Date("2025-07-15T22:00:00");
			const estimatedEndAt = new Date("2025-07-16T02:00:00");
			
			const result = calculateIdleDays(pickupAt, estimatedEndAt);
			
			// This spans 2 calendar days
			expect(result.totalDays).toBe(2);
			expect(result.idleDays).toBe(0);
			expect(result.isMultiDay).toBe(true);
		});

		it("should handle week-long mission", () => {
			const pickupAt = new Date("2025-07-15T08:00:00");
			const estimatedEndAt = new Date("2025-07-21T18:00:00");
			
			const result = calculateIdleDays(pickupAt, estimatedEndAt);
			
			expect(result.totalDays).toBe(7);
			expect(result.idleDays).toBe(5);
			expect(result.isMultiDay).toBe(true);
		});
	});

	// =========================================================================
	// getDailyReferenceRevenue() Tests
	// =========================================================================
	describe("getDailyReferenceRevenue", () => {
		it("LOE-05: should use configured dailyReferenceRevenue when available", () => {
			const vehicleCategory = {
				dailyReferenceRevenue: 450,
				defaultRatePerHour: 50,
			};
			const baseRatePerHour = 40;
			
			const result = getDailyReferenceRevenue(vehicleCategory, baseRatePerHour);
			
			expect(result.revenue).toBe(450);
			expect(result.source).toBe("CONFIGURED");
		});

		it("LOE-06: should calculate from hourly rate when no configured revenue", () => {
			const vehicleCategory = {
				dailyReferenceRevenue: null,
				defaultRatePerHour: 50,
			};
			const baseRatePerHour = 40;
			
			const result = getDailyReferenceRevenue(vehicleCategory, baseRatePerHour);
			
			expect(result.revenue).toBe(400); // 8 × 50
			expect(result.source).toBe("HOURLY_RATE_8H");
		});

		it("LOE-07: should use base rate when no category data", () => {
			const vehicleCategory = null;
			const baseRatePerHour = 45;
			
			const result = getDailyReferenceRevenue(vehicleCategory, baseRatePerHour);
			
			expect(result.revenue).toBe(360); // 8 × 45
			expect(result.source).toBe("HOURLY_RATE_8H");
		});

		it("should use base rate when category has no rates", () => {
			const vehicleCategory = {
				dailyReferenceRevenue: null,
				defaultRatePerHour: null,
			};
			const baseRatePerHour = 55;
			
			const result = getDailyReferenceRevenue(vehicleCategory, baseRatePerHour);
			
			expect(result.revenue).toBe(440); // 8 × 55
			expect(result.source).toBe("HOURLY_RATE_8H");
		});
	});

	// =========================================================================
	// getSeasonalityCoefficient() Tests
	// =========================================================================
	describe("getSeasonalityCoefficient", () => {
		const defaultSettings = {
			defaultSeasonalityCoefficient: 0.65,
			highSeasonCoefficient: 0.80,
			lowSeasonCoefficient: 0.50,
		};

		it("LOE-08: should return high season coefficient for multiplier >= 1.1", () => {
			const date = new Date("2025-07-15");
			const seasonalMultiplier = { name: "Haute Saison Été", multiplier: 1.15 };
			
			const result = getSeasonalityCoefficient(date, seasonalMultiplier, defaultSettings);
			
			expect(result.coefficient).toBe(0.80);
			expect(result.period).toBe("HIGH_SEASON");
			expect(result.multiplierName).toBe("Haute Saison Été");
		});

		it("LOE-09: should return low season coefficient for multiplier <= 0.95", () => {
			const date = new Date("2025-02-15");
			const seasonalMultiplier = { name: "Basse Saison", multiplier: 0.90 };
			
			const result = getSeasonalityCoefficient(date, seasonalMultiplier, defaultSettings);
			
			expect(result.coefficient).toBe(0.50);
			expect(result.period).toBe("LOW_SEASON");
			expect(result.multiplierName).toBe("Basse Saison");
		});

		it("LOE-10: should return default coefficient when no seasonal multiplier", () => {
			const date = new Date("2025-05-15");
			const seasonalMultiplier = null;
			
			const result = getSeasonalityCoefficient(date, seasonalMultiplier, defaultSettings);
			
			expect(result.coefficient).toBe(0.65);
			expect(result.period).toBe("DEFAULT");
			expect(result.multiplierName).toBeNull();
		});

		it("should return default coefficient for multiplier between 0.95 and 1.1", () => {
			const date = new Date("2025-05-15");
			const seasonalMultiplier = { name: "Normal Period", multiplier: 1.0 };
			
			const result = getSeasonalityCoefficient(date, seasonalMultiplier, defaultSettings);
			
			expect(result.coefficient).toBe(0.65);
			expect(result.period).toBe("DEFAULT");
			expect(result.multiplierName).toBe("Normal Period");
		});

		it("should use default constants when settings are null", () => {
			const date = new Date("2025-07-15");
			const seasonalMultiplier = { name: "High Season", multiplier: 1.2 };
			const emptySettings = {
				defaultSeasonalityCoefficient: null,
				highSeasonCoefficient: null,
				lowSeasonCoefficient: null,
			};
			
			const result = getSeasonalityCoefficient(date, seasonalMultiplier, emptySettings);
			
			expect(result.coefficient).toBe(DEFAULT_SEASONALITY_COEFFICIENTS.HIGH_SEASON);
			expect(result.period).toBe("HIGH_SEASON");
		});
	});

	// =========================================================================
	// calculateLossOfExploitation() Tests
	// =========================================================================
	describe("calculateLossOfExploitation", () => {
		const mockSettings = {
			baseRatePerHour: 50,
			defaultSeasonalityCoefficient: 0.65,
			highSeasonCoefficient: 0.80,
			lowSeasonCoefficient: 0.50,
		} as any; // Cast to avoid full OrganizationPricingSettings type

		it("LOE-11: should calculate loss for 3-day mission in high season", () => {
			const pickupAt = new Date("2025-07-15T08:00:00");
			const estimatedEndAt = new Date("2025-07-17T18:00:00");
			const vehicleCategory = {
				id: "cat-1",
				name: "BERLINE",
				dailyReferenceRevenue: 400,
				defaultRatePerHour: 50,
			};
			const seasonalMultiplier = { name: "Haute Saison", multiplier: 1.15 };
			
			const result = calculateLossOfExploitation(
				pickupAt,
				estimatedEndAt,
				vehicleCategory,
				seasonalMultiplier,
				mockSettings,
			);
			
			// 1 idle day × 400€ × 0.80 = 320€
			expect(result.idleDays).toBe(1);
			expect(result.dailyReferenceRevenue).toBe(400);
			expect(result.seasonalityCoefficient).toBe(0.80);
			expect(result.lossOfExploitation).toBe(320);
			expect(result.seasonalityPeriod).toBe("HIGH_SEASON");
			expect(result.calculation.formula).toContain("320.00€");
		});

		it("LOE-12: should calculate loss for 5-day mission in low season", () => {
			const pickupAt = new Date("2025-02-15T08:00:00");
			const estimatedEndAt = new Date("2025-02-19T18:00:00");
			const vehicleCategory = {
				id: "cat-1",
				name: "BERLINE",
				dailyReferenceRevenue: 400,
				defaultRatePerHour: 50,
			};
			const seasonalMultiplier = { name: "Basse Saison", multiplier: 0.90 };
			
			const result = calculateLossOfExploitation(
				pickupAt,
				estimatedEndAt,
				vehicleCategory,
				seasonalMultiplier,
				mockSettings,
			);
			
			// 3 idle days × 400€ × 0.50 = 600€
			expect(result.idleDays).toBe(3);
			expect(result.dailyReferenceRevenue).toBe(400);
			expect(result.seasonalityCoefficient).toBe(0.50);
			expect(result.lossOfExploitation).toBe(600);
			expect(result.seasonalityPeriod).toBe("LOW_SEASON");
		});

		it("should return 0 loss for single-day mission", () => {
			const pickupAt = new Date("2025-07-15T08:00:00");
			const estimatedEndAt = new Date("2025-07-15T18:00:00");
			const vehicleCategory = {
				id: "cat-1",
				name: "BERLINE",
				dailyReferenceRevenue: 400,
				defaultRatePerHour: 50,
			};
			
			const result = calculateLossOfExploitation(
				pickupAt,
				estimatedEndAt,
				vehicleCategory,
				null,
				mockSettings,
			);
			
			expect(result.idleDays).toBe(0);
			expect(result.lossOfExploitation).toBe(0);
			expect(result.isMultiDay).toBe(false);
			expect(result.calculation.formula).toBe("N/A (no idle days)");
		});

		it("should use hourly rate when no configured daily revenue", () => {
			const pickupAt = new Date("2025-07-15T08:00:00");
			const estimatedEndAt = new Date("2025-07-17T18:00:00");
			const vehicleCategory = {
				id: "cat-1",
				name: "BERLINE",
				dailyReferenceRevenue: null,
				defaultRatePerHour: 60,
			};
			
			const result = calculateLossOfExploitation(
				pickupAt,
				estimatedEndAt,
				vehicleCategory,
				null,
				mockSettings,
			);
			
			// 1 idle day × (8 × 60 = 480€) × 0.65 = 312€
			expect(result.dailyReferenceRevenue).toBe(480);
			expect(result.dailyRevenueSource).toBe("HOURLY_RATE_8H");
			expect(result.lossOfExploitation).toBe(312);
		});

		it("should include vehicle category info in result", () => {
			const pickupAt = new Date("2025-07-15T08:00:00");
			const estimatedEndAt = new Date("2025-07-17T18:00:00");
			const vehicleCategory = {
				id: "cat-berline",
				name: "Berline Premium",
				dailyReferenceRevenue: 500,
				defaultRatePerHour: 60,
			};
			
			const result = calculateLossOfExploitation(
				pickupAt,
				estimatedEndAt,
				vehicleCategory,
				null,
				mockSettings,
			);
			
			expect(result.vehicleCategoryId).toBe("cat-berline");
			expect(result.vehicleCategoryName).toBe("Berline Premium");
		});
	});

	// =========================================================================
	// buildLossOfExploitationRule() Tests
	// =========================================================================
	describe("buildLossOfExploitationRule", () => {
		it("LOE-13: should build rule with correct description", () => {
			const result: LossOfExploitationResult = {
				totalDays: 3,
				idleDays: 1,
				isMultiDay: true,
				dailyReferenceRevenue: 400,
				dailyRevenueSource: "CONFIGURED",
				vehicleCategoryId: "cat-1",
				vehicleCategoryName: "BERLINE",
				seasonalityCoefficient: 0.80,
				seasonalityPeriod: "HIGH_SEASON",
				seasonalityMultiplierName: "Haute Saison",
				lossOfExploitation: 320,
				calculation: {
					formula: "1 × 400.00€ × 80% = 320.00€",
					idleDays: 1,
					dailyRevenue: 400,
					coefficient: 0.80,
					total: 320,
				},
			};
			
			const rule = buildLossOfExploitationRule(result);
			
			expect(rule).not.toBeNull();
			expect(rule!.type).toBe("LOSS_OF_EXPLOITATION");
			expect(rule!.description).toContain("1 jour(s)");
			expect(rule!.description).toContain("400.00€");
			expect(rule!.description).toContain("80%");
			expect(rule!.description).toContain("haute saison");
			expect(rule!.amount).toBe(320);
			expect(rule!.details.idleDays).toBe(1);
			expect(rule!.details.dailyRevenue).toBe(400);
			expect(rule!.details.seasonalityCoefficient).toBe(0.80);
			expect(rule!.details.seasonalityPeriod).toBe("HIGH_SEASON");
		});

		it("LOE-14: should return null for 0 idle days", () => {
			const result: LossOfExploitationResult = {
				totalDays: 1,
				idleDays: 0,
				isMultiDay: false,
				dailyReferenceRevenue: 400,
				dailyRevenueSource: "CONFIGURED",
				vehicleCategoryId: "cat-1",
				vehicleCategoryName: "BERLINE",
				seasonalityCoefficient: 0.65,
				seasonalityPeriod: "DEFAULT",
				seasonalityMultiplierName: null,
				lossOfExploitation: 0,
				calculation: {
					formula: "N/A (no idle days)",
					idleDays: 0,
					dailyRevenue: 400,
					coefficient: 0.65,
					total: 0,
				},
			};
			
			const rule = buildLossOfExploitationRule(result);
			
			expect(rule).toBeNull();
		});

		it("should use correct period label for low season", () => {
			const result: LossOfExploitationResult = {
				totalDays: 5,
				idleDays: 3,
				isMultiDay: true,
				dailyReferenceRevenue: 400,
				dailyRevenueSource: "CONFIGURED",
				vehicleCategoryId: "cat-1",
				vehicleCategoryName: "BERLINE",
				seasonalityCoefficient: 0.50,
				seasonalityPeriod: "LOW_SEASON",
				seasonalityMultiplierName: "Basse Saison",
				lossOfExploitation: 600,
				calculation: {
					formula: "3 × 400.00€ × 50% = 600.00€",
					idleDays: 3,
					dailyRevenue: 400,
					coefficient: 0.50,
					total: 600,
				},
			};
			
			const rule = buildLossOfExploitationRule(result);
			
			expect(rule).not.toBeNull();
			expect(rule!.description).toContain("basse saison");
		});

		it("should use correct period label for default season", () => {
			const result: LossOfExploitationResult = {
				totalDays: 3,
				idleDays: 1,
				isMultiDay: true,
				dailyReferenceRevenue: 400,
				dailyRevenueSource: "CONFIGURED",
				vehicleCategoryId: "cat-1",
				vehicleCategoryName: "BERLINE",
				seasonalityCoefficient: 0.65,
				seasonalityPeriod: "DEFAULT",
				seasonalityMultiplierName: null,
				lossOfExploitation: 260,
				calculation: {
					formula: "1 × 400.00€ × 65% = 260.00€",
					idleDays: 1,
					dailyRevenue: 400,
					coefficient: 0.65,
					total: 260,
				},
			};
			
			const rule = buildLossOfExploitationRule(result);
			
			expect(rule).not.toBeNull();
			expect(rule!.description).toContain("période standard");
		});
	});

	// =========================================================================
	// Edge Cases
	// =========================================================================
	describe("Edge Cases", () => {
		it("should handle very long mission (30 days)", () => {
			const pickupAt = new Date("2025-07-01T08:00:00");
			const estimatedEndAt = new Date("2025-07-30T18:00:00");
			
			const result = calculateIdleDays(pickupAt, estimatedEndAt);
			
			expect(result.totalDays).toBe(30);
			expect(result.idleDays).toBe(28);
			expect(result.isMultiDay).toBe(true);
		});

		it("should handle mission ending at midnight", () => {
			const pickupAt = new Date("2025-07-15T08:00:00");
			const estimatedEndAt = new Date("2025-07-17T00:00:00");
			
			const result = calculateIdleDays(pickupAt, estimatedEndAt);
			
			expect(result.totalDays).toBe(3);
			expect(result.idleDays).toBe(1);
		});

		it("should handle null vehicle category gracefully", () => {
			const pickupAt = new Date("2025-07-15T08:00:00");
			const estimatedEndAt = new Date("2025-07-17T18:00:00");
			const mockSettings = {
				baseRatePerHour: 50,
				defaultSeasonalityCoefficient: 0.65,
				highSeasonCoefficient: 0.80,
				lowSeasonCoefficient: 0.50,
			} as any;
			
			const result = calculateLossOfExploitation(
				pickupAt,
				estimatedEndAt,
				null,
				null,
				mockSettings,
			);
			
			expect(result.vehicleCategoryId).toBeNull();
			expect(result.vehicleCategoryName).toBeNull();
			expect(result.dailyReferenceRevenue).toBe(400); // 8 × 50
			expect(result.dailyRevenueSource).toBe("HOURLY_RATE_8H");
		});
	});
});
